<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë†ì¥Â·ëª©ì¥Â·ì•¼ì™¸í™œë™ ì‹œë®¬ë ˆì´í„° - ë¹š 100ë§Œ ê³¨ë“œ ê°šê¸° (ëª¨ë°”ì¼ ëŒ€ì‘)</title>
  <style>
    :root {
      --tile-size: 26px;
      --tile-gap: 3px;
      --ranch-size: 32px;
      --ranch-gap: 4px;
      --base-font: 12px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%, #020617 100%);
      color: #e5e7eb;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      font-size: var(--base-font);
    }
    .game {
      max-width: 1200px;
      width: 100%;
      padding: 16px 10px 32px;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 26px;
      letter-spacing: 0.02em;
    }
    .subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .card {
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.35);
      background: radial-gradient(circle at top left, rgba(15,23,42,0.96), rgba(15,23,42,0.93));
      padding: 10px 12px;
      margin-bottom: 10px;
      box-shadow: 0 22px 60px rgba(15,23,42,0.95);
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at top, rgba(56,189,248,0.04), transparent 65%);
      opacity: 0.7;
      pointer-events: none;
    }
    .card h2 {
      margin: 0 0 4px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      position: relative;
      z-index: 1;
    }

    .top-info-content {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 8px;
      position: relative;
      z-index: 1;
    }
    .stats {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 13px;
    }
    .stat-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: radial-gradient(circle at top left, rgba(15,23,42,0.9), rgba(15,23,42,0.75));
      border: 1px solid rgba(148,163,184,0.25);
      box-shadow: 0 10px 25px rgba(15,23,42,0.7);
      white-space: nowrap;
    }
    .debt-box {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
    }
    .debt-input-wrap {
      display: flex;
      gap: 4px;
      align-items: center;
      justify-content: flex-start;
    }
    input[type="number"] {
      background: #020617;
      border-radius: 8px;
      border: 1px solid #334155;
      padding: 2px 4px;
      color: #e5e7eb;
      width: 80px;
      font-size: 11px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      background: linear-gradient(135deg,#1f2937,#020617);
      color: #e5e7eb;
      box-shadow: 0 10px 24px rgba(0,0,0,0.75);
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, background 0.08s;
      position: relative;
      z-index: 1;
    }
    .btn.small {
      padding: 4px 8px;
      font-size: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.6);
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 28px rgba(0,0,0,0.85);
      background: linear-gradient(135deg,#111827,#020617);
    }
    .btn.primary {
      background: linear-gradient(135deg,#22c55e,#4ade80);
      color: #022c22;
      font-weight: 600;
    }
    .btn.primary:hover {
      background: linear-gradient(135deg,#4ade80,#86efac);
    }
    .btn.selected {
      outline: 2px solid #facc15;
      outline-offset: 1px;
    }
    .btn.danger {
      background: linear-gradient(135deg,#b91c1c,#ef4444);
    }
    .btn.danger:hover {
      background: linear-gradient(135deg,#ef4444,#f97373);
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
      margin-bottom: 4px;
    }
    .main-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .tool-hint {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .explain-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      z-index: 1;
    }
    .explain-body {
      margin-top: 4px;
      font-size: 11px;
      color: #d1d5db;
      position: relative;
      z-index: 1;
    }
    .explain-body.collapsed { display: none; }

    .log-box {
      max-height: 160px;
      overflow-y: auto;
      padding-right: 4px;
      font-size: 11px;
      position: relative;
      z-index: 1;
      -webkit-overflow-scrolling: touch;
    }
    .log-entry { margin-bottom: 2px; }

    .row-2col {
      display: flex;
      gap: 10px;
      align-items: stretch;
    }
    .row-2col > .card {
      flex: 1;
      margin-bottom: 0;
    }

    .farm-grid {
      display: grid;
      grid-template-columns: repeat(9, var(--tile-size));
      grid-template-rows: repeat(9, var(--tile-size));
      gap: var(--tile-gap);
      margin-top: 4px;
      position: relative;
      z-index: 1;
    }
    .tile {
      width: var(--tile-size);
      height: var(--tile-size);
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      border: 1px solid rgba(15,23,42,0.9);
      transition: transform 0.05s, box-shadow 0.05s, background 0.1s, border 0.1s;
      user-select: none;
    }
    .tile:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.6);
    }
    .tile.grass { background: linear-gradient(135deg,#14532d,#166534); }
    .tile.tilled { background: linear-gradient(135deg,#78350f,#854d0e); }
    .tile.crop-1 { background: linear-gradient(135deg,#166534,#15803d); }
    .tile.crop-2 { background: linear-gradient(135deg,#15803d,#22c55e); }
    .tile.crop-3 { background: linear-gradient(135deg,#16a34a,#4ade80); border-color:#facc15; }
    .tile.watered { box-shadow: 0 0 0 2px rgba(56,189,248,0.7); }
    .tile.low-quality {
      filter: grayscale(0.4) brightness(0.95);
      border-color: #9ca3af !important;
    }
    .tile.locked {
      background: linear-gradient(135deg,#111827,#020617);
      border-style: dashed;
      border-color: #4b5563;
      color: #4b5563;
      cursor: default;
      box-shadow: none;
    }
    .tile.locked:hover {
      transform: none;
      box-shadow: none;
    }

    .ranch-grid {
      display: grid;
      grid-template-columns: repeat(6, var(--ranch-size));
      grid-auto-rows: var(--ranch-size);
      gap: var(--ranch-gap);
      margin-top: 4px;
      position: relative;
      z-index: 1;
    }
    .ranch-tile {
      width: var(--ranch-size);
      height: var(--ranch-size);
      border-radius: 10px;
      background: radial-gradient(circle at top, #0f172a, #020617);
      border: 1px solid rgba(148,163,184,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      cursor: pointer;
      transition: transform 0.05s, box-shadow 0.05s, background 0.1s;
    }
    .ranch-tile:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.6);
      background: radial-gradient(circle at top, #111827,#020617);
    }
    .ranch-tile.locked {
      cursor: default;
      border-style: dashed;
      border-color: #4b5563;
      color: #4b5563;
      background: radial-gradient(circle at top, #020617,#020617);
      box-shadow: none;
      font-size: 12px;
    }
    .ranch-tile.locked:hover {
      transform: none;
      box-shadow: none;
      background: radial-gradient(circle at top, #020617,#020617);
    }
    .ranch-empty {
      font-size: 10px;
      color: #4b5563;
    }

    .shop-row, .item-row, .quest-row, .warehouse-row, .resident-row, .line-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
      margin-bottom: 4px;
      position: relative;
      z-index: 1;
    }
    .section-label {
      font-size: 11px;
      font-weight: 600;
      margin: 6px 0 3px;
      color: #e5e7eb;
      position: relative;
      z-index: 1;
    }
    .badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      font-size: 10px;
      color: #cbd5f5;
      margin-left: 4px;
    }
    .hint {
      font-size: 11px;
      color: #9ca3af;
      position: relative;
      z-index: 1;
    }

    .house-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      position: relative;
      z-index: 1;
    }
    .house-icon {
      width: 46px;
      height: 46px;
      border-radius: 14px;
      background: radial-gradient(circle at top, #f97316,#facc15);
      box-shadow: 0 12px 26px rgba(248,181,28,0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
    }

    .affinity-bar {
      font-family: "Courier New", monospace;
      font-size: 10px;
      letter-spacing: 1px;
    }

    @media (max-width: 960px) {
      .row-2col {
        flex-direction: column;
      }
    }
    @media (max-width: 768px) {
      :root {
        --tile-size: 22px;
        --tile-gap: 3px;
        --ranch-size: 28px;
        --ranch-gap: 3px;
        --base-font: 11px;
      }
      body {
        font-size: var(--base-font);
      }
      .game {
        padding: 14px 8px 28px;
      }
      h1 {
        font-size: 22px;
      }
      .card {
        padding: 8px 10px;
        border-radius: 14px;
      }
    }
    @media (max-width: 480px) {
      :root {
        --tile-size: 19px;
        --ranch-size: 24px;
        --base-font: 10px;
      }
      body {
        font-size: var(--base-font);
      }
      h1 {
        font-size: 20px;
      }
      .btn {
        padding: 5px 10px;
        font-size: 11px;
      }
      .btn.small {
        padding: 3px 6px;
        font-size: 10px;
      }
    }
  </style>
</head>
<body>
  <audio id="bgm" loop>
    <source src="bgm.mp3" type="audio/mpeg" />
  </audio>

  <div class="game">
    <h1>ë†ì¥Â·ëª©ì¥Â·ì•¼ì™¸í™œë™ ì‹œë®¬ë ˆì´í„°</h1>
    <div class="subtitle">ìŠ¤íƒ€ë“€ ê°ì„±ìœ¼ë¡œ ë¹š 1,000,000G ê°šê¸°</div>

    <!-- ìƒë‹¨ ì •ë³´ -->
    <div class="card">
      <div class="top-info-content">
        <div class="stats">
          <div class="stat-pill">ğŸ“… <span id="seasonName">ë´„</span> <span id="seasonDay">1</span>ì¼ì°¨ (ì´ <span id="day">1</span>ì¼)</div>
          <div class="stat-pill">ğŸŒ¦ <span id="weatherText">ë§‘ìŒ</span></div>
          <div class="stat-pill">ğŸ’° ê³¨ë“œ: <span id="gold">500</span>G</div>
          <div class="stat-pill">âš¡ ì—ë„ˆì§€: <span id="energy">100</span>/<span id="maxEnergyLabel">100</span></div>
        </div>
      </div>
    </div>

    <!-- ë¹š ì „ìš© ì¹´ë“œ -->
    <div class="card">
      <h2>ğŸ’¸ ë¹š ìƒí™©</h2>
      <div class="debt-box">
        <div>í˜„ì¬ ë¹š: <b><span id="debt">1000000</span>G</b></div>
        <div class="debt-input-wrap">
          <input type="number" id="debtPayInput" min="1" placeholder="ë³€ì œ ê¸ˆì•¡" />
          <button class="btn small primary" id="debtPayBtn">ë¹› ë³€ì œí•˜ê¸°</button>
        </div>
        <div class="hint">ë¹šì„ 0Gë¡œ ë§Œë“¤ë©´ ì—”ë”©ì…ë‹ˆë‹¤.</div>
      </div>
    </div>

    <!-- ì£¼ìš” ë²„íŠ¼ (ë‹¤ìŒë‚  / BGMë§Œ) -->
    <div class="card">
      <h2>ğŸ¯ ì£¼ìš” ë²„íŠ¼</h2>
      <div class="main-actions">
        <button class="btn primary" id="nextDayBtn">â­ ë‹¤ìŒë‚  ë³´ë‚´ê¸°</button>
        <button class="btn small" id="bgmToggleBtn">ğŸ”ˆ BGM ì¼œê¸°</button>
      </div>
    </div>

    <!-- ê²Œì„ ì„¤ëª… (ì ‘ê¸°/í¼ì¹˜ê¸°) -->
    <div class="card">
      <div class="explain-header">
        <h2>ğŸ® ê²Œì„ ì„¤ëª…</h2>
        <button class="btn small" id="explainToggleBtn">ë”ë³´ê¸°</button>
      </div>
      <div class="explain-body collapsed" id="explainBody">
        ì´ ê²Œì„ì˜ ëª©í‘œëŠ” <b>ë†ì¥Â·ëª©ì¥Â·ì•¼ì™¸í™œë™Â·ë§ˆì„ ì˜ë¢°</b>ë¥¼ í†µí•´ ê³¨ë“œë¥¼ ë²Œì–´<br>
        <b>ì´ ë¹š 1,000,000G</b>ë¥¼ ëª¨ë‘ ê°šê³  <b>ë¹› 0ì›</b>ì„ ë§Œë“œëŠ” ê²ƒì…ë‹ˆë‹¤.<br><br>
        - ê³„ì ˆë§ˆë‹¤ ì‹¬ì„ ìˆ˜ ìˆëŠ” ì‘ë¬¼ì´ ë‹¤ë¥´ë©°, <b>íŒë§¤ê°€ê°€ ë†’ì€ ì‘ë¬¼ì¼ìˆ˜ë¡ ì„±ì¥ ì¼ìˆ˜ê°€ ë” ê¹ë‹ˆë‹¤.</b><br>
        - ì œì² ì´ ì§€ë‚œ ì‘ë¬¼ì€ <b>í•˜ê¸‰í’ˆ(50%)</b>ìœ¼ë¡œ ë–¨ì–´ì§‘ë‹ˆë‹¤.<br>
        - ë°­ê³¼ ëª©ì¥ì€ ê³¨ë“œë¥¼ íˆ¬ìí•´ <b>í™•ì¥</b>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
        - ë§ˆì„ ì£¼ë¯¼ ì˜ë¢°ë¥¼ ìˆ˜í–‰í•˜ë©´ <b>í˜¸ê°ë„</b>ê°€ ì˜¬ë¼ê°€ê³ , í˜¸ê°ë„ 100ì´ ë˜ë©´ <b>ê²°í˜¼</b>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
        - ê²°í˜¼ í›„ì—ëŠ” ë°°ìš°ìê°€ ìƒˆë²½ë§ˆë‹¤ ë†ì¥ì˜ ì¼ë¶€ ì‘ì—…ì„ ìë™ìœ¼ë¡œ ë„ì™€ì¤ë‹ˆë‹¤.<br>
        - ì•„ì´í…œì€ ìƒì ì—ì„œ êµ¬ì…í•˜ê³ , <b>ì°½ê³ ì—ì„œ ì‚¬ìš©Â·íŒë§¤</b>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
    </div>

    <!-- ë¡œê·¸ -->
    <div class="card">
      <h2>ğŸ“œ ë¡œê·¸</h2>
      <div class="log-box" id="log"></div>
    </div>

    <!-- 1í–‰: ë†ì¥ / ì”¨ì•— ìƒì  -->
    <div class="row-2col">
      <div class="card">
        <h2>ğŸŒ¾ ë†ì¥</h2>
        <div class="line-row">
          <div class="hint">ë„êµ¬ì™€ ì”¨ì•—ì„ ì„ íƒí•œ ë’¤ ë°­ì„ í´ë¦­í•´ ì‘ì—…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
          <div id="farmUpgradeInfo"></div>
        </div>

        <!-- ë„êµ¬ ë²„íŠ¼ & í˜„ì¬ ì”¨ì•—/ë„êµ¬ ì •ë³´ -->
        <div class="toolbar">
          <button class="btn selected" data-tool="plow">ğŸª“ ìŸê¸°</button>
          <button class="btn" data-tool="seeder" id="seederBtn">ğŸŒ± íŒŒì¢…ê¸°</button>
          <button class="btn" data-tool="water">ğŸ’§ ë¬¼ë¿Œë¦¬ê°œ</button>
          <button class="btn" data-tool="harvest">ğŸ§º í˜¸ë¯¸</button>
        </div>
        <div class="tool-hint" id="toolHint"></div>

        <div class="farm-grid" id="farmGrid"></div>
      </div>

      <div class="card">
        <h2>ğŸŒ± ì”¨ì•— ìƒì  (í˜„ì¬ ê³„ì ˆ ì „ìš©)</h2>
        <div id="cropList"></div>
      </div>
    </div>

    <!-- 2í–‰: ëª©ì¥ / ë§ˆì„ ì˜ë¢° -->
    <div class="row-2col">
      <div class="card">
        <h2>ğŸ„ ëª©ì¥</h2>
        <div class="line-row">
          <div>í˜„ì¬ ì„ íƒ ê°€ì¶•: <span id="ranchSelectedLabel"><b>ì†Œ ğŸ„</b></span></div>
          <div>
            <button class="btn small" data-animal="cow">ì†Œ (800G)</button>
            <button class="btn small" data-animal="sheep">ì–‘ (700G)</button>
            <button class="btn small" data-animal="pig">ë¼ì§€ (600G)</button>
          </div>
        </div>
        <div class="line-row">
          <div class="hint">ëª©ì¥ì€ ê³¨ë“œë¥¼ íˆ¬ìí•´ ìµœëŒ€ 30ì¹¸ê¹Œì§€ í™•ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
          <div id="ranchUpgradeInfo"></div>
        </div>
        <div class="ranch-grid" id="ranchGrid"></div>
        <div class="line-row" style="margin-top:4px;">
          <div>
            <span class="section-label">ê°€ì¶• ìˆ˜í™•</span><br>
            <span class="hint">
              - ì†Œ: ìš°ìœ  (ìœ ì¶•ê¸° í•„ìš”)<br>
              - ì–‘: ì–‘í„¸ (ì–‘í„¸ê°€ìœ„ í•„ìš”)<br>
              - ë¼ì§€: ê°€ì¶• íŒë§¤ë¡œë§Œ ìˆ˜ìµ
            </span>
          </div>
          <div style="display:flex; flex-direction:column; gap:3px;">
            <button class="btn small" id="milkBtn">ğŸ¥› ì†Œ ìš°ìœ  ì§œê¸°</button>
            <button class="btn small" id="shearBtn">âœ‚ï¸ ì–‘ í„¸ ê¹ê¸°</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ˜ ë§ˆì„ ì˜ë¢°</h2>
        <div id="questList"></div>
        <div class="section-label" style="margin-top:6px;">ğŸ¡ ë§ˆì„ íŠ¹ìˆ˜ ì´ë²¤íŠ¸</div>
        <div id="villageEventInfo">ì˜¤ëŠ˜ì€ ì•„ì§ ì¡°ìš©í•©ë‹ˆë‹¤.</div>
      </div>
    </div>

    <!-- 3í–‰: ì°½ê³  -->
    <div class="card">
      <h2>ğŸ“¦ ì°½ê³ </h2>
      <div id="warehouseInfo"></div>
    </div>

    <!-- 4í–‰: ì˜¤ë‘ë§‰/ì•¼ì™¸í™œë™ / ì•„ì´í…œ ìƒì  -->
    <div class="row-2col">
      <div class="card">
        <h2>ğŸ¡ ì˜¤ë‘ë§‰ & ì—…ê·¸ë ˆì´ë“œ</h2>
        <div class="house-header">
          <div class="house-icon">ğŸ </div>
          <div>
            <div><b id="houseNameLabel">ì˜¤ë‘ë§‰ (Lv.1)</b></div>
            <div style="font-size:11px;color:#cbd5f5;">
              ì§‘ì„ ì—…ê·¸ë ˆì´ë“œí•˜ë©´ ìµœëŒ€ ì—ë„ˆì§€ê°€ ëŠ˜ì–´ë‚˜ê³ ,<br>
              ê²°í˜¼ í›„ì—ëŠ” ë°°ìš°ìì™€ í•¨ê»˜ ê±°ì£¼í•˜ë©° ë†ì¥ ì¼ì„ ë„ì™€ì¤ë‹ˆë‹¤.
            </div>
          </div>
        </div>
        <div id="houseInfo"></div>
        <div class="section-label" style="margin-top:6px;">ğŸ”§ ë†ê¸°êµ¬ & ëª©ì¥ ë„êµ¬ ì—…ê·¸ë ˆì´ë“œ</div>
        <div id="toolUpgradeInfo"></div>

        <div class="section-label" style="margin-top:8px;">â›º ì•¼ì™¸ í™œë™ (ê´‘ì‚° & ë‚šì‹œí„°)</div>
        <div class="item-row">
          <div>
            â› <b>ê´‘ì‚° íƒí—˜</b><br>
            <span class="hint">ì—ë„ˆì§€ 15 ì†Œëª¨ / ê´‘ì„ê³¼ ë ˆì–´ ê¸ˆì†ì„ ì±„êµ´í•©ë‹ˆë‹¤.</span>
          </div>
          <button class="btn small" id="mineExploreBtn">ê´‘ì‚° ê°€ê¸°</button>
        </div>
        <div class="item-row">
          <div>
            ğŸ£ <b>ë‚šì‹œí•˜ê¸°</b><br>
            <span class="hint">ì—ë„ˆì§€ 10 ì†Œëª¨ / í”¼ë¼ë¯¸Â·ì†¡ì‚¬ë¦¬Â·ë¶•ì–´Â·ì‰ì–´ ë“±ì„ ë‚šìŠµë‹ˆë‹¤.</span>
          </div>
          <button class="btn small" id="fishBtn">ë‚šì‹œí•˜ê¸°</button>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ’ ì•„ì´í…œ ìƒì </h2>
        <div id="itemsInfo"></div>
      </div>
    </div>

    <!-- 5í–‰: ë§ˆì„ ì£¼ë¯¼ í˜¸ê°ë„ -->
    <div class="card">
      <h2>ğŸ‘¥ ë§ˆì„ ì£¼ë¯¼ í˜¸ê°ë„</h2>
      <div id="residentsInfo"></div>
    </div>
  </div>

  <script>
    // ===== ìƒìˆ˜ ë° ìœ í‹¸ =====
    const MAX_FARM_SIZE = 9;
    const DAYS_PER_SEASON = 20;
    const MINE_ENERGY_COST = 15;
    const FISH_ENERGY_COST = 10;
    const BASE_FIELD_TOOL_COST_PER_TILE = 5;
    const BASE_MILKER_COST_PER_ANIMAL = 6;
    const BASE_SHEARS_COST_PER_ANIMAL = 6;
    const MAX_TOOL_LEVEL = 5;
    const INITIAL_DEBT = 1000000;
    const MAX_RANCH_SLOTS = 30;

    const TOOL_EFFICIENCY = { 1:1.0, 2:0.7, 3:0.55, 4:0.45, 5:0.4 };

    const seasonIds = ["spring","summer","fall","winter"];
    const seasonNames = {
      spring:"ë´„", summer:"ì—¬ë¦„", fall:"ê°€ì„", winter:"ê²¨ìš¸"
    };

    function computeGrowStages(price) {
      // ê°€ê²©ì´ ë¹„ìŒ€ìˆ˜ë¡ ì„±ì¥ ì¼ìˆ˜ ì¦ê°€
      if (price <= 50) return 3;   // ì €ê°€ ì‘ë¬¼: 3ì¼
      if (price <= 80) return 4;   // ì¤‘ê°„: 4ì¼
      if (price <= 110) return 5;  // ë¹„ì‹¼ í¸: 5ì¼
      return 6;                    // ì•„ì£¼ ë¹„ì‹¼ ì‘ë¬¼: 6ì¼+
    }

    const weatherTypes = [
      { id:"sun",   name:"ë§‘ìŒ", icon:"â˜€ï¸",  weight:0.6,  desc:"ë”°ëœ»í•˜ê³  í‰í™”ë¡œìš´ ë‚ ì”¨ì…ë‹ˆë‹¤." },
      { id:"rain",  name:"ë¹„",   icon:"ğŸŒ§ï¸",  weight:0.25, desc:"ë°¤ìƒˆ ë‚´ë¦° ë¹„ ë•ë¶„ì— ë°­ì´ ì¶©ë¶„íˆ ì ì…”ì¡ŒìŠµë‹ˆë‹¤." },
      { id:"cloud", name:"íë¦¼", icon:"â›…",  weight:0.15, desc:"êµ¬ë¦„ì´ ë‚€ ì”ì”í•œ í•˜ë£¨ì…ë‹ˆë‹¤." }
    ];

    // ì‘ë¬¼: growStagesëŠ” ë‚˜ì¤‘ì— ê°€ê²© ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
    const crops = {
      carrot:    { id:"carrot",    name:"ë‹¹ê·¼",    emoji:"ğŸ¥•", buyPrice:20,  sellPrice:45,  seasons:["spring","fall"] },
      tomato:    { id:"tomato",    name:"í† ë§ˆí† ",  emoji:"ğŸ…", buyPrice:30,  sellPrice:65,  seasons:["summer"] },
      potato:    { id:"potato",    name:"ê°ì",    emoji:"ğŸ¥”", buyPrice:25,  sellPrice:55,  seasons:["spring"] },
      corn:      { id:"corn",      name:"ì˜¥ìˆ˜ìˆ˜",  emoji:"ğŸŒ½", buyPrice:35,  sellPrice:75,  seasons:["summer","fall"] },
      strawberry:{ id:"strawberry",name:"ë”¸ê¸°",    emoji:"ğŸ“", buyPrice:40,  sellPrice:90,  seasons:["spring"] },
      pumpkin:   { id:"pumpkin",   name:"í˜¸ë°•",    emoji:"ğŸƒ", buyPrice:50,  sellPrice:120, seasons:["fall"] },
      rice:      { id:"rice",      name:"ë²¼",      emoji:"ğŸŒ¾", buyPrice:45,  sellPrice:95,  seasons:["summer","fall"] },
      pepper:    { id:"pepper",    name:"ê³ ì¶”",    emoji:"ğŸŒ¶ï¸", buyPrice:35,  sellPrice:80,  seasons:["summer"] },
      eggplant:  { id:"eggplant",  name:"ê°€ì§€",    emoji:"ğŸ†", buyPrice:30,  sellPrice:70,  seasons:["summer"] },
      cabbage:   { id:"cabbage",   name:"ì–‘ë°°ì¶”",  emoji:"ğŸ¥¬", buyPrice:30,  sellPrice:70,  seasons:["spring"] },
      wheat:     { id:"wheat",     name:"ë°€",      emoji:"ğŸŒ¾", buyPrice:25,  sellPrice:60,  seasons:["fall"] }
    };
    // íŒë§¤ê°€ ê¸°ì¤€ìœ¼ë¡œ ì„±ì¥ ì¼ìˆ˜ ê³„ì‚°
    Object.values(crops).forEach(c => {
      c.growStages = computeGrowStages(c.sellPrice);
    });

    const LIVESTOCK_DEFS = {
      cow:   { id:"cow",   name:"ì†Œ",   emoji:"ğŸ„", buyPrice:800, feedCost:15 },
      sheep: { id:"sheep", name:"ì–‘",   emoji:"ğŸ‘", buyPrice:700, feedCost:12 },
      pig:   { id:"pig",   name:"ë¼ì§€", emoji:"ğŸ–", buyPrice:600, feedCost:10 }
    };

    const HOUSE_LEVELS = [
      { level:1, name:"ì˜¤ë‘ë§‰",     bonusMaxEnergy:0,  upgradeCost:1000,  desc:"ê¸°ë³¸ ë†ì¥. ìµœëŒ€ ì—ë„ˆì§€ 100." },
      { level:2, name:"ì‘ì€ ì§‘",   bonusMaxEnergy:20, upgradeCost:3000,  desc:"ì¡°ê¸ˆ ë” ë„“ì–´ì§„ ì§‘. ìµœëŒ€ ì—ë„ˆì§€ +20." },
      { level:3, name:"ì•„ëŠ‘í•œ ì§‘", bonusMaxEnergy:30, upgradeCost:6000,  desc:"í›¨ì”¬ í¸ì•ˆí•œ ì§‘. ìµœëŒ€ ì—ë„ˆì§€ +30." },
      { level:4, name:"í¸ì•ˆí•œ ì§‘", bonusMaxEnergy:40, upgradeCost:12000, desc:"ì—¬ìœ ë¡œìš´ ê³µê°„. ìµœëŒ€ ì—ë„ˆì§€ +40." },
      { level:5, name:"ë†ì¥ ì €íƒ", bonusMaxEnergy:60, upgradeCost:null,  desc:"ê¶ê·¹ì˜ ë†ì¥ ì§‘. ìµœëŒ€ ì—ë„ˆì§€ +60." }
    ];

    // ì•„ì´í…œ 10ì¢…
    const ITEM_DEFS = {
      coffee: {
        id:"coffee", name:"ë”°ëœ»í•œ ì»¤í”¼", emoji:"â˜•",
        desc:"ì—ë„ˆì§€ +25 íšŒë³µ", price:80, sellPrice:40
      },
      bread: {
        id:"bread", name:"ë“ ë“ í•œ ë¹µ", emoji:"ğŸ",
        desc:"ì—ë„ˆì§€ +35 íšŒë³µ", price:110, sellPrice:55
      },
      lunchbox: {
        id:"lunchbox", name:"ì ì‹¬ ë„ì‹œë½", emoji:"ğŸ±",
        desc:"ì—ë„ˆì§€ +60 íšŒë³µ", price:180, sellPrice:90
      },
      energyDrink: {
        id:"energyDrink", name:"ì—ë„ˆì§€ ë“œë§í¬", emoji:"âš¡",
        desc:"ì—ë„ˆì§€ ì™„ì „ íšŒë³µ", price:220, sellPrice:110
      },
      fertilizer: {
        id:"fertilizer", name:"ë¹„ë£Œ í¬ëŒ€", emoji:"ğŸ§ª",
        desc:"ë¬´ì‘ìœ„ ì‘ë¬¼ ì—¬ëŸ¬ ì¹¸ì„ í•œ ë‹¨ê³„ ì„±ì¥", price:150, sellPrice:75
      },
      contractor: {
        id:"contractor", name:"ìš©ì—­ì—…ì²´ ì¿ í°", emoji:"ğŸ“¦",
        desc:"ì˜¤ëŠ˜ ë°­ ì „ì²´ ë¬¼ì£¼ê¸° & ìˆ˜í™• ìë™ ì²˜ë¦¬", price:400, sellPrice:200
      },
      luckyCoin: {
        id:"luckyCoin", name:"í–‰ìš´ì˜ ë™ì „", emoji:"ğŸª™",
        desc:"ì¦‰ì‹œ 200G íšë“", price:260, sellPrice:130
      },
      oreBox: {
        id:"oreBox", name:"ê´‘ë¬¼ ìƒì", emoji:"ğŸ“¦",
        desc:"ëŒÂ·êµ¬ë¦¬Â·ì²  ê´‘ì„ì„ ë¬´ì‘ìœ„ë¡œ íšë“", price:240, sellPrice:120
      },
      fishBox: {
        id:"fishBox", name:"ìƒì„  ìƒì", emoji:"ğŸ",
        desc:"ë¬´ì‘ìœ„ ìƒì„  ì—¬ëŸ¬ ë§ˆë¦¬ íšë“", price:240, sellPrice:120
      },
      animalSnack: {
        id:"animalSnack", name:"ê°€ì¶• ê°„ì‹", emoji:"ğŸ¦´",
        desc:"ì†ŒÂ·ì–‘ì—ì„œ ìš°ìœ Â·ì–‘í„¸ì„ ì¦‰ì‹œ ì¡°ê¸ˆ ì–»ìŒ", price:260, sellPrice:130
      }
    };

    const ORES = {
      stone:   { id:"stone",   name:"ëŒ",        emoji:"ğŸª¨", sellPrice:5 },
      copper:  { id:"copper",  name:"êµ¬ë¦¬ ê´‘ì„", emoji:"ğŸŸ¤", sellPrice:20 },
      iron:    { id:"iron",    name:"ì²  ê´‘ì„",   emoji:"âš™ï¸", sellPrice:40 },
      goldOre: { id:"goldOre", name:"ê¸ˆ ê´‘ì„",   emoji:"ğŸ’°", sellPrice:100 }
    };

    const FISH = {
      pirami:   { id:"pirami",   name:"í”¼ë¼ë¯¸", emoji:"ğŸŸ", sellPrice:15 },
      songsari: { id:"songsari", name:"ì†¡ì‚¬ë¦¬", emoji:"ğŸŸ", sellPrice:20 },
      bungeo:   { id:"bungeo",   name:"ë¶•ì–´",   emoji:"ğŸ ", sellPrice:35 },
      inge:     { id:"inge",     name:"ì‰ì–´",   emoji:"ğŸ¡", sellPrice:60 }
    };

    const ANIMAL_PRODUCTS = {
      milk: { id:"milk", name:"ìš°ìœ ", emoji:"ğŸ¥›", sellPrice:60 },
      wool: { id:"wool", name:"ì–‘í„¸", emoji:"ğŸ§¶", sellPrice:90 }
    };

    const RESIDENTS = [
      { id:"alex",   name:"Alex Johnson",   gender:"M" },
      { id:"hiro",   name:"Hiro Tanaka",    gender:"M" },
      { id:"minjun", name:"Minjun Park",    gender:"M" },
      { id:"diego",  name:"Diego Alvarez",  gender:"M" },
      { id:"jamal",  name:"Jamal Okafor",   gender:"M" },
      { id:"emily",  name:"Emily Carter",   gender:"F" },
      { id:"yuna",   name:"Yuna Sato",      gender:"F" },
      { id:"jiwoo",  name:"Jiwoo Kim",      gender:"F" },
      { id:"sofia",  name:"Sofia Garcia",   gender:"F" },
      { id:"aisha",  name:"Aisha Hassan",   gender:"F" }
    ];

    // ===== ìƒíƒœ =====
    const state = {
      day:1,
      seasonDay:1,
      seasonIndex:0,
      weatherId:"sun",
      gold:500,
      debt:INITIAL_DEBT,
      energy:100,
      baseMaxEnergy:100,
      maxEnergy:100,
      activeTool:"plow",
      toolLevels:{
        plow:1, seeder:1, water:1, harvest:1,
        milker:1, shears:1
      },
      tiles:[],
      farmLevel:1,
      selectedCropId:"carrot",
      ranchStalls:[],
      ranchUnlockedSlots:2,
      ranchSelectedAnimal:"cow",
      questOffers:[],
      activeQuests:[],
      villageEvent:null,
      houseLevel:1,
      items:{},
      residents:RESIDENTS.map(r=>({ ...r, affinity:0, married:false })),
      marriedResidentId:null,
      gameCompleted:false,
      warehouse:{
        crops:{},
        animal:{ milk:0, wool:0 },
        ores:{ stone:0, copper:0, iron:0, goldOre:0 },
        fish:{ pirami:0, songsari:0, bungeo:0, inge:0 }
      }
    };

    // ì°½ê³  ì‘ë¬¼ ì´ˆê¸°í™”
    Object.values(crops).forEach(c=>{
      state.warehouse.crops[c.id] = { normal:0, low:0 };
    });
    // ì•„ì´í…œ ì´ˆê¸°í™”
    Object.values(ITEM_DEFS).forEach(it=>{
      state.items[it.id] = 0;
    });

    // ===== DOM =====
    const dayEl = document.getElementById("day");
    const seasonNameEl = document.getElementById("seasonName");
    const seasonDayEl = document.getElementById("seasonDay");
    const weatherTextEl = document.getElementById("weatherText");
    const goldEl = document.getElementById("gold");
    const debtEl = document.getElementById("debt");
    const energyEl = document.getElementById("energy");
    const maxEnergyLabelEl = document.getElementById("maxEnergyLabel");
    const logEl = document.getElementById("log");
    const farmGridEl = document.getElementById("farmGrid");
    const farmUpgradeInfoEl = document.getElementById("farmUpgradeInfo");
    const cropListEl = document.getElementById("cropList");
    const ranchGridEl = document.getElementById("ranchGrid");
    const ranchSelectedLabelEl = document.getElementById("ranchSelectedLabel");
    const ranchUpgradeInfoEl = document.getElementById("ranchUpgradeInfo");
    const questListEl = document.getElementById("questList");
    const villageEventInfoEl = document.getElementById("villageEventInfo");
    const warehouseInfoEl = document.getElementById("warehouseInfo");
    const houseInfoEl = document.getElementById("houseInfo");
    const houseNameLabelEl = document.getElementById("houseNameLabel");
    const toolUpgradeInfoEl = document.getElementById("toolUpgradeInfo");
    const itemsInfoEl = document.getElementById("itemsInfo");
    const residentsInfoEl = document.getElementById("residentsInfo");
    const toolButtons = document.querySelectorAll(".toolbar .btn");
    const seederBtn = document.getElementById("seederBtn");
    const toolHintEl = document.getElementById("toolHint");
    const nextDayBtn = document.getElementById("nextDayBtn");
    const bgmAudio = document.getElementById("bgm");
    const bgmToggleBtn = document.getElementById("bgmToggleBtn");
    const ranchAnimalButtons = document.querySelectorAll("button[data-animal]");
    const milkBtn = document.getElementById("milkBtn");
    const shearBtn = document.getElementById("shearBtn");
    const mineExploreBtn = document.getElementById("mineExploreBtn");
    const fishBtn = document.getElementById("fishBtn");
    const debtPayInput = document.getElementById("debtPayInput");
    const debtPayBtn = document.getElementById("debtPayBtn");
    const explainToggleBtn = document.getElementById("explainToggleBtn");
    const explainBody = document.getElementById("explainBody");

    // ===== ìœ í‹¸ =====
    function getSeasonId(){ return seasonIds[state.seasonIndex]; }
    function randomChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function log(msg){
      const div = document.createElement("div");
      div.className = "log-entry";
      div.textContent = "Â· " + msg;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }
    function getWeatherDef(){
      return weatherTypes.find(w=>w.id===state.weatherId) || weatherTypes[0];
    }
    function pickRandomWeather(){
      const r = Math.random();
      let acc = 0;
      for(const w of weatherTypes){
        acc += w.weight;
        if(r<=acc) return w.id;
      }
      return "sun";
    }
    function spendEnergy(amount){
      if(state.energy < amount){
        alert("ì—ë„ˆì§€ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
        return false;
      }
      state.energy -= amount;
      return true;
    }
    function affinityBar(v){
      const total = 10;
      const filled = Math.round((v/100)*total);
      return "â–ˆ".repeat(filled) + "â–‘".repeat(total - filled);
    }
    function getToolName(id){
      switch(id){
        case "plow": return "ìŸê¸°";
        case "seeder": return "íŒŒì¢…ê¸°";
        case "water": return "ë¬¼ë¿Œë¦¬ê°œ";
        case "harvest": return "í˜¸ë¯¸";
        case "milker": return "ìœ ì¶•ê¸°";
        case "shears": return "ì–‘í„¸ê°€ìœ„";
        default: return "";
      }
    }
    function getResidentIcon(res){
      if(!res) return "â“";
      const base = res.gender==="M" ? "ğŸ‘¨" : "ğŸ‘©";
      if(res.married || state.marriedResidentId === res.id) return "ğŸ’" + base;
      return base;
    }

    // ===== ì´ˆê¸°í™” =====
    function initFarm(){
      state.tiles = [];
      farmGridEl.innerHTML = "";
      for(let y=0;y<MAX_FARM_SIZE;y++){
        for(let x=0;x<MAX_FARM_SIZE;x++){
          const tile = {
            type:"grass",
            cropId:null,
            stage:0,
            wateredToday:false,
            quality:1.0,
            locked:true
          };
          state.tiles.push(tile);
          const div = document.createElement("div");
          div.className = "tile grass";
          div.dataset.index = y*MAX_FARM_SIZE + x;
          div.addEventListener("click", onTileClick);
          farmGridEl.appendChild(div);
        }
      }
      applyFarmLock();
      log("ë†ì¥ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function applyFarmLock(){
      const center = Math.floor(MAX_FARM_SIZE/2);
      let radius;
      if(state.farmLevel===1) radius = 2;   // 5x5
      else if(state.farmLevel===2) radius = 3; // 7x7
      else radius = 4;                     // 9x9
      for(let y=0;y<MAX_FARM_SIZE;y++){
        for(let x=0;x<MAX_FARM_SIZE;x++){
          const idx = y*MAX_FARM_SIZE + x;
          const tile = state.tiles[idx];
          const dx = Math.abs(x-center);
          const dy = Math.abs(y-center);
          const unlocked = (dx<=radius && dy<=radius);
          tile.locked = !unlocked;
          if(tile.locked){
            tile.type = "grass";
            tile.cropId = null;
            tile.stage = 0;
            tile.wateredToday = false;
            tile.quality = 1.0;
          }
        }
      }
    }

    function initRanch(){
      state.ranchStalls = [];
      ranchGridEl.innerHTML = "";
      for(let i=0;i<MAX_RANCH_SLOTS;i++){
        state.ranchStalls.push({ animalId:null });
        const div = document.createElement("div");
        div.className = "ranch-tile";
        div.dataset.index = i;
        div.addEventListener("click", onRanchTileClick);
        ranchGridEl.appendChild(div);
      }
      updateRanchUI();
    }

    function initCropList(){
      cropListEl.innerHTML = "";
      const seasonId = getSeasonId();
      const available = Object.values(crops).filter(c=>c.seasons.includes(seasonId));
      if(available.length===0){
        const msg = document.createElement("div");
        msg.className = "hint";
        msg.textContent = "í˜„ì¬ ê³„ì ˆì— ì‹¬ì„ ìˆ˜ ìˆëŠ” ì”¨ì•—ì´ ì—†ìŠµë‹ˆë‹¤.";
        cropListEl.appendChild(msg);
        return;
      }
      if(!available.some(c=>c.id===state.selectedCropId)){
        state.selectedCropId = available[0].id;
      }
      available.forEach(crop=>{
        const row = document.createElement("div");
        row.className = "shop-row";
        const left = document.createElement("div");
        left.innerHTML = `${crop.emoji} <b>${crop.name}</b>
          <span class="badge">${crop.buyPrice}G â†’ ${crop.sellPrice}G</span>
          <span class="badge">ì„±ì¥ ${crop.growStages}ì¼</span>`;
        const btn = document.createElement("button");
        btn.className = "btn small";
        btn.textContent = "ì”¨ì•— ì„ íƒ";
        btn.addEventListener("click", ()=>{
          state.selectedCropId = crop.id;
          log(`${crop.name} ì”¨ì•—ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`);
          updateSelectedCropUI();
        });
        row.appendChild(left);
        row.appendChild(btn);
        cropListEl.appendChild(row);
      });
      updateSelectedCropUI();
    }

    // ===== UI =====
    function updateSelectedCropUI(){
      const crop = crops[state.selectedCropId];
      if(crop && seederBtn){
        seederBtn.textContent = `ğŸŒ± íŒŒì¢…ê¸° (${crop.name} ì‹¬ê¸°)`;
      }
      updateToolHint();
    }

    function updateStatsUI(){
      dayEl.textContent = state.day;
      seasonDayEl.textContent = state.seasonDay;
      seasonNameEl.textContent = seasonNames[getSeasonId()];
      const w = getWeatherDef();
      weatherTextEl.textContent = `${w.icon} ${w.name}`;
      goldEl.textContent = state.gold;
      debtEl.textContent = state.debt;
      energyEl.textContent = state.energy;
      maxEnergyLabelEl.textContent = state.maxEnergy;
    }

    function getTile(idx){ return state.tiles[idx]; }

    function updateFarmUI(){
      const divs = farmGridEl.querySelectorAll(".tile");
      divs.forEach((div,idx)=>{
        const t = getTile(idx);
        div.className = "tile";
        let icon = "";
        if(t.locked){
          div.classList.add("locked");
          div.textContent = "ğŸ”’";
          return;
        }
        if(t.type==="grass"){
          div.classList.add("grass");
        } else if(t.type==="tilled"){
          div.classList.add("tilled");
} else if(t.type==="crop" && t.cropId){
  const crop = crops[t.cropId];
  const growStages = crop.growStages || 1;

  // í˜„ì¬ ì„±ì¥ ì§„í–‰ë„(0 ~ 1 ì´ìƒ)
  const progress = t.stage / growStages;

  // ì‹œê°ì ìœ¼ë¡œ ë³´ì—¬ì¤„ 3ë‹¨ê³„ ìŠ¤í…Œì´ì§€(1,2,3)
  let visualStage;
  if (progress <= 0) {
    visualStage = 0;      // ê±°ì˜ ì”¨ì•— ë‹¨ê³„ (ì‚¬ì‹¤ìƒ ì•ˆ ë‚˜ì™€ì•¼ í•  ìƒíƒœ)
  } else if (progress < 0.4) {
    visualStage = 1;      // ì´ˆë°˜ ì„±ì¥
  } else if (progress < 1) {
    visualStage = 2;      // ì¤‘í›„ë°˜ ì„±ì¥
  } else {
    visualStage = 3;      // ì™„ì „íˆ ì„±ì¥
  }

  if (visualStage === 1) {
    div.classList.add("crop-1");
    icon = crop.emoji;
  } else if (visualStage === 2) {
    div.classList.add("crop-2");
    icon = crop.emoji;
  } else if (visualStage === 3) {
    div.classList.add("crop-3");
    icon = crop.emoji;
    if (t.quality && t.quality < 1) {
      div.classList.add("low-quality");
    }
  } else {
    // í˜¹ì‹œë¼ë„ ì˜ˆì™¸ê°€ ìˆìœ¼ë©´ ìµœì†Œí•œ ê°ˆë¦° ë•…ìœ¼ë¡œ
    div.classList.add("tilled");
  }
}
        if(t.wateredToday){
          div.classList.add("watered");
        }
        div.textContent = icon;
      });
      // ë°­ í™•ì¥ ì •ë³´
      let html = "";
      if(state.farmLevel < 3){
        const nextLevel = state.farmLevel+1;
        const cost = farmUpgradeCost();
        html = `<button class="btn small" id="farmUpgradeBtn">ë°­ í™•ì¥ (Lv.${nextLevel}, ${cost}G)</button>`;
      } else {
        html = `<span class="hint">ë°­ì€ ìµœëŒ€ í¬ê¸°ì…ë‹ˆë‹¤.</span>`;
      }
      farmUpgradeInfoEl.innerHTML = html;
      const btn = document.getElementById("farmUpgradeBtn");
      if(btn){
        btn.addEventListener("click", expandFarm);
      }
    }

    function updateRanchUI(){
      const divs = ranchGridEl.querySelectorAll(".ranch-tile");
      divs.forEach((div,idx)=>{
        const stall = state.ranchStalls[idx];
        div.innerHTML = "";
        if(idx >= state.ranchUnlockedSlots){
          div.classList.add("locked");
          div.textContent = "ğŸ”’";
          return;
        } else {
          div.classList.remove("locked");
        }
        if(!stall.animalId){
          const span = document.createElement("span");
          span.className = "ranch-empty";
          span.textContent = "ë¹ˆì¹¸";
          div.appendChild(span);
        } else {
          const def = LIVESTOCK_DEFS[stall.animalId];
          div.textContent = def ? def.emoji : "?";
        }
      });
      const def = LIVESTOCK_DEFS[state.ranchSelectedAnimal];
      ranchSelectedLabelEl.innerHTML = `<b>${def.name} ${def.emoji}</b>`;

      // ëª©ì¥ í™•ì¥ ì •ë³´
      let html = "";
      if(state.ranchUnlockedSlots < MAX_RANCH_SLOTS){
        const cost = ranchUpgradeCost();
        html = `<button class="btn small" id="ranchUpgradeBtn">ëª©ì¥ í™•ì¥ (+4ì¹¸, ${cost}G)</button>`;
      } else {
        html = `<span class="hint">ëª©ì¥ì€ ìµœëŒ€ í¬ê¸°ì…ë‹ˆë‹¤.</span>`;
      }
      ranchUpgradeInfoEl.innerHTML = html;
      const btn = document.getElementById("ranchUpgradeBtn");
      if(btn) btn.addEventListener("click", expandRanch);
    }

    function updateToolHint(){
      const crop = crops[state.selectedCropId];
      const toolName = getToolName(state.activeTool);
      const level = state.toolLevels[state.activeTool] || 1;
      const eff = TOOL_EFFICIENCY[level] || 1.0;
      const approxTiles = (["plow","seeder","water","harvest"].includes(state.activeTool) && level>=2) ? 9 : 1;
      const approxCost = Math.ceil(BASE_FIELD_TOOL_COST_PER_TILE * eff * approxTiles);
      if(crop){
        toolHintEl.textContent =
          `í˜„ì¬ ì”¨ì•—: ${crop.name} / ì„ íƒ ë„êµ¬: ${toolName} Lv.${level} / 1íšŒ ì‚¬ìš© ì˜ˆìƒ ì—ë„ˆì§€: ì•½ ${approxCost}`;
      } else {
        toolHintEl.textContent = "";
      }
    }

    function updateQuestUI(){
      questListEl.innerHTML = "";

      // ì‹ ê·œ ì˜ë¢°
      const title1 = document.createElement("div");
      title1.className = "section-label";
      title1.textContent = "ì˜¤ëŠ˜ì˜ ì‹ ê·œ ì˜ë¢° (ìµœëŒ€ 3ê±´)";
      questListEl.appendChild(title1);

      if(state.questOffers.length === 0){
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.textContent = "ì˜¤ëŠ˜ì€ ìƒˆë¡œìš´ ì˜ë¢°ê°€ ì—†ìŠµë‹ˆë‹¤.";
        questListEl.appendChild(empty);
      } else {
        state.questOffers.forEach((q,idx)=>{
          const crop = crops[q.cropId];
          const res = state.residents.find(r=>r.id===q.clientResidentId);
          const icon = getResidentIcon(res);
          const row = document.createElement("div");
          row.className = "quest-row";
          const left = document.createElement("div");
          left.innerHTML = `<b>${idx+1}.</b> ì˜ë¢°ì¸: ${icon} <b>${res ? res.name : "???"}</b><br>
            ëª©í‘œ: <b>${crop.emoji} ${crop.name} ${q.target}ê°œ ë‚©í’ˆ</b><br>
            ë³´ìƒ: ${q.reward}G`;
          const right = document.createElement("div");
          if(!q.accepted){
            const btn = document.createElement("button");
            btn.className = "btn small";
            btn.textContent = "í€˜ìŠ¤íŠ¸ ë°›ê¸°";
            btn.addEventListener("click", ()=>{
              acceptQuest(idx);
            });
            right.appendChild(btn);
          } else {
            const span = document.createElement("span");
            span.className = "hint";
            span.textContent = "ìˆ˜ë½ë¨";
            right.appendChild(span);
          }
          row.appendChild(left);
          row.appendChild(right);
          questListEl.appendChild(row);
        });
      }

      // ìˆ˜ë½í•œ ì˜ë¢°
      const title2 = document.createElement("div");
      title2.className = "section-label";
      title2.textContent = "ì§„í–‰ ì¤‘ì¸ ì˜ë¢°";
      questListEl.appendChild(title2);

      if(state.activeQuests.length === 0){
        const empty2 = document.createElement("div");
        empty2.className = "hint";
        empty2.textContent = "ì§„í–‰ ì¤‘ì¸ ì˜ë¢°ê°€ ì—†ìŠµë‹ˆë‹¤.";
        questListEl.appendChild(empty2);
      } else {
        state.activeQuests.forEach((q,idx)=>{
          const crop = crops[q.cropId];
          const res = state.residents.find(r=>r.id===q.clientResidentId);
          const icon = getResidentIcon(res);
          const row = document.createElement("div");
          row.className = "quest-row";
          const left = document.createElement("div");
          left.innerHTML = `<b>${idx+1}.</b> ì˜ë¢°ì¸: ${icon} <b>${res ? res.name : "???"}</b><br>
            ëª©í‘œ: <b>${crop.emoji} ${crop.name} ${q.target}ê°œ ë‚©í’ˆ</b><br>
            ì§„í–‰ë„: ${q.progress}/${q.target} / ë³´ìƒ: ${q.reward}G
            ${q.completed ? '<br><span style="color:#bbf7d0;">ì™„ë£Œë¨</span>' : ""}`;
          const right = document.createElement("div");
          if(!q.completed){
            const btn = document.createElement("button");
            btn.className = "btn small danger";
            btn.textContent = "í€˜ìŠ¤íŠ¸ ì·¨ì†Œ";
            btn.addEventListener("click", ()=>{
              cancelActiveQuest(idx);
            });
            right.appendChild(btn);
          }
          row.appendChild(left);
          row.appendChild(right);
          questListEl.appendChild(row);
        });
      }
    }

    function updateVillageEventUI(){
      const ev = state.villageEvent;
      if(!ev){
        villageEventInfoEl.textContent = "ì˜¤ëŠ˜ì€ ë§ˆì„ì´ ì¡°ìš©í•œ í•˜ë£¨ì…ë‹ˆë‹¤.";
      } else {
        villageEventInfoEl.innerHTML = `<b>${ev.title}</b><br>${ev.text}`;
      }
    }

    function updateItemsUI(){
      itemsInfoEl.innerHTML = "";
      Object.values(ITEM_DEFS).forEach(def=>{
        const row = document.createElement("div");
        row.className = "item-row";
        const left = document.createElement("div");
        const count = state.items[def.id] || 0;
        left.innerHTML = `${def.emoji} <b>${def.name}</b> (ë³´ìœ : ${count}ê°œ)
          <span class="badge">ê°€ê²©: ${def.price}G</span><br>
          <span class="hint">${def.desc}</span>`;
        const right = document.createElement("div");
        const buyBtn = document.createElement("button");
        buyBtn.className = "btn small";
        buyBtn.textContent = "êµ¬ì…";
        buyBtn.addEventListener("click", ()=>{
          if(state.gold < def.price){
            alert(`${def.name}ì„(ë¥¼) ì‚´ ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${def.price}G)`);
            return;
          }
          state.gold -= def.price;
          state.items[def.id] = (state.items[def.id] || 0) + 1;
          log(`${def.name}ì„(ë¥¼) êµ¬ì…í–ˆìŠµë‹ˆë‹¤. (-${def.price}G)`);
          updateStatsUI();
          updateItemsUI();
          updateWarehouseUI();
        });
        right.appendChild(buyBtn);
        row.appendChild(left);
        row.appendChild(right);
        itemsInfoEl.appendChild(row);
      });
      const hint = document.createElement("div");
      hint.className = "hint";
      hint.textContent = "ì•„ì´í…œì€ ìƒì ì—ì„œë§Œ êµ¬ì…í•  ìˆ˜ ìˆìœ¼ë©°, ì‚¬ìš©Â·íŒë§¤ëŠ” ì°½ê³ ì—ì„œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      itemsInfoEl.appendChild(hint);
    }

    function updateHouseUI(){
      const levelCfg = HOUSE_LEVELS.find(h=>h.level===state.houseLevel);
      const nextCfg = HOUSE_LEVELS.find(h=>h.level===state.houseLevel+1);
      houseNameLabelEl.textContent = `${levelCfg.name} (Lv.${levelCfg.level})`;
      let html = "";
      html += `<div>í˜„ì¬ ì§‘ ì„¤ëª…: ${levelCfg.desc}</div>`;
      html += `<div style="margin-top:4px;">í˜„ì¬ ìµœëŒ€ ì—ë„ˆì§€: <b>${state.maxEnergy}</b></div>`;
      if(state.marriedResidentId){
        const sp = state.residents.find(r=>r.id===state.marriedResidentId);
        if(sp){
          html += `<div style="margin-top:4px;">í•¨ê»˜ ì‚¬ëŠ” ì£¼ë¯¼: ${getResidentIcon(sp)} <b>${sp.name}</b> ğŸ’</div>`;
        }
      }
      if(nextCfg){
        html += `<div style="margin-top:6px;">ë‹¤ìŒ ì§‘: <b>${nextCfg.name}</b> (ì—…ê·¸ë ˆì´ë“œ ë¹„ìš©: ${nextCfg.upgradeCost}G)</div>`;
        html += `<button class="btn small" id="houseUpgradeBtn">ì§‘ ì—…ê·¸ë ˆì´ë“œ</button>`;
      } else {
        html += `<div class="hint" style="margin-top:4px;">ì§‘ì€ ìµœëŒ€ ë ˆë²¨ì…ë‹ˆë‹¤.</div>`;
      }
      houseInfoEl.innerHTML = html;
      const btn = document.getElementById("houseUpgradeBtn");
      if(btn && nextCfg){
        btn.addEventListener("click", upgradeHouse);
      }

      // ë„êµ¬ ì—…ê·¸ë ˆì´ë“œ
      let toolsHtml = "";
      ["plow","seeder","water","harvest","milker","shears"].forEach(id=>{
        const level = state.toolLevels[id] || 1;
        const isMax = level >= MAX_TOOL_LEVEL;
        const rangeLabel = (["plow","seeder","water","harvest"].includes(id))
          ? (level>=2 ? "3Ã—3" : "1ì¹¸")
          : "ì‚¬ìš© íš¨ìœ¨ ì¦ê°€";
        const upgradeCost = 1000 * level;
        toolsHtml += `<div class="line-row">
          <div>${getToolName(id)} Lv.${level} / ${rangeLabel}</div>`;
        if(!isMax){
          toolsHtml += `<button class="btn small" data-upgrade-tool="${id}">ì—…ê·¸ë ˆì´ë“œ (${upgradeCost}G)</button>`;
        } else {
          toolsHtml += `<span class="hint">ìµœëŒ€ ë ˆë²¨</span>`;
        }
        toolsHtml += `</div>`;
      });
      toolUpgradeInfoEl.innerHTML = toolsHtml;
      const upBtns = toolUpgradeInfoEl.querySelectorAll("button[data-upgrade-tool]");
      upBtns.forEach(btn=>{
        btn.addEventListener("click",()=>{
          const id = btn.getAttribute("data-upgrade-tool");
          upgradeTool(id);
        });
      });
    }

    function updateWarehouseUI(){
      warehouseInfoEl.innerHTML = "";

      // ì‘ë¬¼
      const cropsTitle = document.createElement("div");
      cropsTitle.className = "section-label";
      cropsTitle.textContent = "ğŸŒ± ì‘ë¬¼";
      warehouseInfoEl.appendChild(cropsTitle);
      let anyCrops = false;
      Object.values(crops).forEach(crop=>{
        const entry = state.warehouse.crops[crop.id];
        const normal = entry.normal || 0;
        const low = entry.low || 0;
        if(normal>0){
          anyCrops = true;
          const row = document.createElement("div");
          row.className = "warehouse-row";
          const left = document.createElement("div");
          left.innerHTML = `${crop.emoji} <b>${crop.name}</b> (ì •ìƒí’ˆ) x ${normal}ê°œ
            <span class="badge">${crop.sellPrice}G</span>`;
          const right = document.createElement("div");
          const input = document.createElement("input");
          input.type = "number";
          input.min = 1;
          input.value = normal;
          const btn = document.createElement("button");
          btn.className = "btn small";
          btn.textContent = "íŒ”ê¸°";
          btn.addEventListener("click",()=>{
            sellCrop(crop.id,"normal",parseInt(input.value,10)||0);
          });
          right.appendChild(input);
          right.appendChild(btn);
          row.appendChild(left);
          row.appendChild(right);
          warehouseInfoEl.appendChild(row);
        }
        if(low>0){
          anyCrops = true;
          const row = document.createElement("div");
          row.className = "warehouse-row";
          const left = document.createElement("div");
          left.innerHTML = `${crop.emoji} <b>${crop.name}</b> (í•˜ê¸‰í’ˆ) x ${low}ê°œ
            <span class="badge">${Math.floor(crop.sellPrice*0.5)}G</span>`;
          const right = document.createElement("div");
          const input = document.createElement("input");
          input.type = "number";
          input.min = 1;
          input.value = low;
          const btn = document.createElement("button");
          btn.className = "btn small";
          btn.textContent = "íŒ”ê¸°";
          btn.addEventListener("click",()=>{
            sellCrop(crop.id,"low",parseInt(input.value,10)||0);
          });
          right.appendChild(input);
          right.appendChild(btn);
          row.appendChild(left);
          row.appendChild(right);
          warehouseInfoEl.appendChild(row);
        }
      });
      if(!anyCrops){
        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = "ë³´ìœ  ì¤‘ì¸ ì‘ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.";
        warehouseInfoEl.appendChild(hint);
      }

      // ê°€ì¶• ë¶€ì‚°ë¬¼
      const animalTitle = document.createElement("div");
      animalTitle.className = "section-label";
      animalTitle.textContent = "ğŸ„ ê°€ì¶• ë¶€ì‚°ë¬¼";
      warehouseInfoEl.appendChild(animalTitle);
      let anyAnimal = false;
      Object.values(ANIMAL_PRODUCTS).forEach(p=>{
        const count = state.warehouse.animal[p.id] || 0;
        if(count<=0) return;
        anyAnimal = true;
        const row = document.createElement("div");
        row.className = "warehouse-row";
        const left = document.createElement("div");
        left.innerHTML = `${p.emoji} <b>${p.name}</b> x ${count}ê°œ <span class="badge">${p.sellPrice}G</span>`;
        const right = document.createElement("div");
        const input = document.createElement("input");
        input.type = "number";
        input.min = 1;
        input.value = count;
        const btn = document.createElement("button");
        btn.className = "btn small";
        btn.textContent = "íŒ”ê¸°";
        btn.addEventListener("click",()=>{
          sellAnimalProduct(p.id, parseInt(input.value,10)||0);
        });
        right.appendChild(input);
        right.appendChild(btn);
        row.appendChild(left);
        row.appendChild(right);
        warehouseInfoEl.appendChild(row);
      });
      if(!anyAnimal){
        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = "ë³´ìœ  ì¤‘ì¸ ê°€ì¶• ë¶€ì‚°ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.";
        warehouseInfoEl.appendChild(hint);
      }

      // ê´‘ì„
      const oreTitle = document.createElement("div");
      oreTitle.className = "section-label";
      oreTitle.textContent = "â› ê´‘ì„";
      warehouseInfoEl.appendChild(oreTitle);
      let anyOre = false;
      Object.values(ORES).forEach(o=>{
        const count = state.warehouse.ores[o.id] || 0;
        if(count<=0) return;
        anyOre = true;
        const row = document.createElement("div");
        row.className = "warehouse-row";
        const left = document.createElement("div");
        left.innerHTML = `${o.emoji} <b>${o.name}</b> x ${count}ê°œ <span class="badge">${o.sellPrice}G</span>`;
        const right = document.createElement("div");
        const input = document.createElement("input");
        input.type = "number";
        input.min = 1;
        input.value = count;
        const btn = document.createElement("button");
        btn.className = "btn small";
        btn.textContent = "íŒ”ê¸°";
        btn.addEventListener("click",()=>{
          sellOre(o.id, parseInt(input.value,10)||0);
        });
        right.appendChild(input);
        right.appendChild(btn);
        row.appendChild(left);
        row.appendChild(right);
        warehouseInfoEl.appendChild(row);
      });
      if(!anyOre){
        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = "ë³´ìœ  ì¤‘ì¸ ê´‘ì„ì´ ì—†ìŠµë‹ˆë‹¤.";
        warehouseInfoEl.appendChild(hint);
      }

      // ìƒì„ 
      const fishTitle = document.createElement("div");
      fishTitle.className = "section-label";
      fishTitle.textContent = "ğŸ£ ìƒì„ ";
      warehouseInfoEl.appendChild(fishTitle);
      let anyFish = false;
      Object.values(FISH).forEach(f=>{
        const count = state.warehouse.fish[f.id] || 0;
        if(count<=0) return;
        anyFish = true;
        const row = document.createElement("div");
        row.className = "warehouse-row";
        const left = document.createElement("div");
        left.innerHTML = `${f.emoji} <b>${f.name}</b> x ${count}ë§ˆë¦¬ <span class="badge">${f.sellPrice}G</span>`;
        const right = document.createElement("div");
        const input = document.createElement("input");
        input.type = "number";
        input.min = 1;
        input.value = count;
        const btn = document.createElement("button");
        btn.className = "btn small";
        btn.textContent = "íŒ”ê¸°";
        btn.addEventListener("click",()=>{
          sellFish(f.id, parseInt(input.value,10)||0);
        });
        right.appendChild(input);
        right.appendChild(btn);
        row.appendChild(left);
        row.appendChild(right);
        warehouseInfoEl.appendChild(row);
      });
      if(!anyFish){
        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = "ë³´ìœ  ì¤‘ì¸ ìƒì„ ì´ ì—†ìŠµë‹ˆë‹¤.";
        warehouseInfoEl.appendChild(hint);
      }

      // ì•„ì´í…œ
      const itemsTitle = document.createElement("div");
      itemsTitle.className = "section-label";
      itemsTitle.textContent = "ğŸ ì•„ì´í…œ";
      warehouseInfoEl.appendChild(itemsTitle);
      let anyItem = false;
      Object.values(ITEM_DEFS).forEach(def=>{
        const count = state.items[def.id] || 0;
        if(count<=0) return;
        anyItem = true;
        const row = document.createElement("div");
        row.className = "warehouse-row";
        const left = document.createElement("div");
        left.innerHTML = `${def.emoji} <b>${def.name}</b> x ${count}ê°œ
          <span class="badge">íŒë§¤ê°€: ${def.sellPrice}G</span>`;
        const right = document.createElement("div");
        const input = document.createElement("input");
        input.type = "number";
        input.min = 1;
        input.value = count;
        const useBtn = document.createElement("button");
        useBtn.className = "btn small";
        useBtn.textContent = "ì‚¬ìš©";
        useBtn.addEventListener("click",()=>{
          useItem(def.id, parseInt(input.value,10)||1, false);
        });
        const sellBtn = document.createElement("button");
        sellBtn.className = "btn small";
        sellBtn.textContent = "íŒ”ê¸°";
        sellBtn.addEventListener("click",()=>{
          sellItem(def.id, parseInt(input.value,10)||0);
        });
        right.appendChild(useBtn);
        right.appendChild(sellBtn);
        row.appendChild(left);
        row.appendChild(right);
        warehouseInfoEl.appendChild(row);
      });
      if(!anyItem){
        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = "ë³´ìœ  ì¤‘ì¸ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.";
        warehouseInfoEl.appendChild(hint);
      }
    }

    function updateResidentsUI(){
      residentsInfoEl.innerHTML = "";

      const males = state.residents.filter(r=>r.gender==="M");
      const females = state.residents.filter(r=>r.gender==="F");

      const maleTitle = document.createElement("div");
      maleTitle.className = "section-label";
      maleTitle.textContent = "ğŸ‘¨ ë‚¨ì„± ì£¼ë¯¼";
      residentsInfoEl.appendChild(maleTitle);

      if(males.length===0){
        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = "ë“±ë¡ëœ ë‚¨ì„± ì£¼ë¯¼ì´ ì—†ìŠµë‹ˆë‹¤.";
        residentsInfoEl.appendChild(hint);
      } else {
        males.forEach(res=>{
          const row = document.createElement("div");
          row.className = "resident-row";
          const left = document.createElement("div");
          const icon = getResidentIcon(res);
          left.innerHTML = `${icon} <b>${res.name}</b> (í˜¸ê°ë„: ${res.affinity}/100)<br>
            <span class="affinity-bar">${affinityBar(res.affinity)}</span>`;
          const right = document.createElement("div");
          if(res.married || state.marriedResidentId === res.id){
            right.innerHTML = `<span class="hint">ë°°ìš°ì</span>`;
          } else if(!state.marriedResidentId && res.affinity >= 100){
            const btn = document.createElement("button");
            btn.className = "btn small";
            btn.textContent = "ê²°í˜¼í•˜ê¸°";
            btn.addEventListener("click",()=>{
              marryResident(res.id);
            });
            right.appendChild(btn);
          }
          row.appendChild(left);
          row.appendChild(right);
          residentsInfoEl.appendChild(row);
        });
      }

      const femaleTitle = document.createElement("div");
      femaleTitle.className = "section-label";
      femaleTitle.textContent = "ğŸ‘© ì—¬ì„± ì£¼ë¯¼";
      residentsInfoEl.appendChild(femaleTitle);

      if(females.length===0){
        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = "ë“±ë¡ëœ ì—¬ì„± ì£¼ë¯¼ì´ ì—†ìŠµë‹ˆë‹¤.";
        residentsInfoEl.appendChild(hint);
      } else {
        females.forEach(res=>{
          const row = document.createElement("div");
          row.className = "resident-row";
          const left = document.createElement("div");
          const icon = getResidentIcon(res);
          left.innerHTML = `${icon} <b>${res.name}</b> (í˜¸ê°ë„: ${res.affinity}/100)<br>
            <span class="affinity-bar">${affinityBar(res.affinity)}</span>`;
          const right = document.createElement("div");
          if(res.married || state.marriedResidentId === res.id){
            right.innerHTML = `<span class="hint">ë°°ìš°ì</span>`;
          } else if(!state.marriedResidentId && res.affinity >= 100){
            const btn = document.createElement("button");
            btn.className = "btn small";
            btn.textContent = "ê²°í˜¼í•˜ê¸°";
            btn.addEventListener("click",()=>{
              marryResident(res.id);
            });
            right.appendChild(btn);
          }
          row.appendChild(left);
          row.appendChild(right);
          residentsInfoEl.appendChild(row);
        });
      }

      const hint = document.createElement("div");
      hint.className = "hint";
      hint.textContent = "ë§ˆì„ ì˜ë¢°ë¥¼ ì™„ë£Œí•˜ë©´ ì˜ë¢°ì¸ì˜ í˜¸ê°ë„ê°€ ìƒìŠ¹í•©ë‹ˆë‹¤. í˜¸ê°ë„ 100ì´ ë˜ë©´ ê²°í˜¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      residentsInfoEl.appendChild(hint);
    }

    function updateUI(){
      updateStatsUI();
      updateFarmUI();
      updateRanchUI();
      updateQuestUI();
      updateVillageEventUI();
      updateItemsUI();
      updateHouseUI();
      updateWarehouseUI();
      updateResidentsUI();
      updateToolHint();
    }

    // ===== ë°­ & ë„êµ¬ =====
    function getAffectedIndices(centerIndex, toolId){
      const level = state.toolLevels[toolId] || 1;
      const isField = ["plow","seeder","water","harvest"].includes(toolId);
      const indices = [];
      if(!isField){
        indices.push(centerIndex);
        return indices;
      }
      const range3x3 = level>=2;
      if(!range3x3){
        indices.push(centerIndex);
      } else {
        const cx = centerIndex % MAX_FARM_SIZE;
        const cy = Math.floor(centerIndex / MAX_FARM_SIZE);
        for(let dy=-1;dy<=1;dy++){
          for(let dx=-1;dx<=1;dx++){
            const nx = cx+dx, ny = cy+dy;
            if(nx>=0 && nx<MAX_FARM_SIZE && ny>=0 && ny<MAX_FARM_SIZE){
              indices.push(ny*MAX_FARM_SIZE + nx);
            }
          }
        }
      }
      return indices;
    }

    function onTileClick(e){
      if(state.gameCompleted){
        log("ì´ë¯¸ ëª¨ë“  ë¹šì„ ê°šì•˜ìŠµë‹ˆë‹¤. ì—”ë”© ì´í›„ì—ëŠ” ììœ ë¡­ê²Œ ë‘˜ëŸ¬ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        return;
      }
      const idx = parseInt(e.currentTarget.dataset.index,10);
      const tile = getTile(idx);
      if(tile.locked){
        log("ì•„ì§ í™•ì¥í•˜ì§€ ì•Šì€ êµ¬ì—­ì…ë‹ˆë‹¤. ë°­ì„ í™•ì¥í•˜ë©´ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        return;
      }
      const indices = getAffectedIndices(idx, state.activeTool).filter(i=>!state.tiles[i].locked);
      if(indices.length===0) return;
      const energyCost = calcFieldToolEnergy(state.activeTool, indices.length);
      if(!spendEnergy(energyCost)) return;

      indices.forEach(i=>{
        const t = getTile(i);
        switch(state.activeTool){
          case "plow": hoeTile(t); break;
          case "seeder": plantTile(t); break;
          case "water": waterTile(t); break;
          case "harvest": harvestTile(t); break;
        }
      });
      log(`${getToolName(state.activeTool)}ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. (-${energyCost} ì—ë„ˆì§€)`);
      updateUI();
    }

    function calcFieldToolEnergy(toolId, tileCount){
      const level = state.toolLevels[toolId] || 1;
      const eff = TOOL_EFFICIENCY[level] || 1.0;
      return Math.ceil(tileCount * BASE_FIELD_TOOL_COST_PER_TILE * eff);
    }

    function calcAnimalToolEnergy(toolId, animalCount){
      const level = state.toolLevels[toolId] || 1;
      const eff = TOOL_EFFICIENCY[level] || 1.0;
      const base = (toolId==="milker") ? BASE_MILKER_COST_PER_ANIMAL : BASE_SHEARS_COST_PER_ANIMAL;
      return Math.ceil(animalCount * base * eff);
    }

    function hoeTile(tile){
      if(tile.type==="grass"){
        tile.type = "tilled";
        tile.cropId = null;
        tile.stage = 0;
        tile.wateredToday = false;
        tile.quality = 1.0;
      }
    }

    function plantTile(tile){
      const seasonId = getSeasonId();
      const crop = crops[state.selectedCropId];
      if(!crop) return;
      if(!crop.seasons.includes(seasonId)){
        alert(`${seasonNames[seasonId]}ì—ëŠ” ${crop.name}ë¥¼ ì‹¬ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        return;
      }
      if(tile.type==="tilled" && tile.stage===0 && !tile.cropId){
        if(state.gold < crop.buyPrice){
          alert(`${crop.name} ì”¨ì•—ì„ ì‚´ ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${crop.buyPrice}G)`);
          return;
        }
        state.gold -= crop.buyPrice;
        tile.type = "crop";
        tile.cropId = crop.id;
        tile.stage = 1;
        tile.wateredToday = false;
        tile.quality = 1.0;
      }
    }

    function waterTile(tile){
      if(tile.type==="crop" && tile.cropId){
        tile.wateredToday = true;
      }
    }

    function harvestTile(tile){
      if(tile.type==="crop" && tile.cropId){
        const crop = crops[tile.cropId];
        if(tile.stage >= crop.growStages){
          const isLow = tile.quality && tile.quality<1;
          const entry = state.warehouse.crops[crop.id];
          if(isLow) entry.low++;
          else entry.normal++;
          tile.type = "tilled";
          tile.stage = 0;
          tile.cropId = null;
          tile.wateredToday = false;
          tile.quality = 1.0;
        }
      }
    }

    // ===== ëª©ì¥ =====
    function onRanchTileClick(e){
      if(state.gameCompleted) return;
      const idx = parseInt(e.currentTarget.dataset.index,10);
      if(idx >= state.ranchUnlockedSlots){
        log("ì•„ì§ í™•ì¥í•˜ì§€ ì•Šì€ ëª©ì¥ ì¹¸ì…ë‹ˆë‹¤. ëª©ì¥ì„ í™•ì¥í•´ì•¼ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        return;
      }
      const stall = state.ranchStalls[idx];
      if(!stall.animalId) buyAnimal(idx);
      else sellAnimal(idx);
      updateStatsUI();
      updateRanchUI();
    }

    function buyAnimal(index){
      const stall = state.ranchStalls[index];
      const def = LIVESTOCK_DEFS[state.ranchSelectedAnimal];
      if(!def) return;
      if(stall.animalId){
        alert("ì´ë¯¸ ê°€ì¶•ì´ ìˆëŠ” ì¹¸ì…ë‹ˆë‹¤.");
        return;
      }
      if(state.gold < def.buyPrice){
        alert(`${def.name}ì„(ë¥¼) ì‚´ ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${def.buyPrice}G)`);
        return;
      }
      state.gold -= def.buyPrice;
      stall.animalId = def.id;
      log(`${def.emoji} ${def.name}ì„(ë¥¼) ë“¤ì˜€ìŠµë‹ˆë‹¤. (-${def.buyPrice}G)`);
    }

    function sellAnimal(index){
      const stall = state.ranchStalls[index];
      const def = LIVESTOCK_DEFS[stall.animalId];
      if(!def) return;
      const refund = Math.floor(def.buyPrice * 0.6);
      state.gold += refund;
      log(`${def.emoji} ${def.name}ì„(ë¥¼) íŒë§¤í–ˆìŠµë‹ˆë‹¤. (+${refund}G)`);
      stall.animalId = null;
    }

    // ===== í™•ì¥ ë¹„ìš© =====
    function farmUpgradeCost(){
      if(state.farmLevel===1) return 1500;
      if(state.farmLevel===2) return 4000;
      return 0;
    }

    function expandFarm(){
      if(state.farmLevel>=3){
        log("ë°­ì€ ì´ë¯¸ ìµœëŒ€ í¬ê¸°ì…ë‹ˆë‹¤.");
        return;
      }
      const cost = farmUpgradeCost();
      if(state.gold < cost){
        alert(`ë°­ì„ í™•ì¥í•  ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${cost}G)`);
        return;
      }
      state.gold -= cost;
      state.farmLevel++;
      applyFarmLock();
      log(`ë°­ì´ í™•ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (í˜„ì¬ ë ˆë²¨: ${state.farmLevel})`);
      updateStatsUI();
      updateFarmUI();
    }

    function ranchUpgradeCost(){
      if(state.ranchUnlockedSlots >= MAX_RANCH_SLOTS) return 0;
      const stepIndex = Math.floor((state.ranchUnlockedSlots - 2)/4);
      return 800 + stepIndex * 600;
    }

    function expandRanch(){
      if(state.ranchUnlockedSlots >= MAX_RANCH_SLOTS){
        log("ëª©ì¥ì€ ì´ë¯¸ ìµœëŒ€ í¬ê¸°ì…ë‹ˆë‹¤.");
        return;
      }
      const cost = ranchUpgradeCost();
      if(state.gold < cost){
        alert(`ëª©ì¥ì„ í™•ì¥í•  ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${cost}G)`);
        return;
      }
      state.gold -= cost;
      state.ranchUnlockedSlots = Math.min(MAX_RANCH_SLOTS, state.ranchUnlockedSlots + 4);
      log(`ëª©ì¥ì´ í™•ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (ì‚¬ìš© ê°€ëŠ¥í•œ ì¹¸: ${state.ranchUnlockedSlots}ì¹¸)`);
      updateStatsUI();
      updateRanchUI();
    }

    // ===== ë‹¤ìŒë‚  =====
    function calcMaxEnergy(){
      let bonus = 0;
      HOUSE_LEVELS.forEach(h=>{
        if(h.level <= state.houseLevel) bonus += h.bonusMaxEnergy;
      });
      return state.baseMaxEnergy + bonus;
    }

    function handleLivestockDaily(){
      const counts = { cow:0, sheep:0, pig:0 };
      state.ranchStalls.forEach(s=>{
        if(s.animalId) counts[s.animalId]++;
      });
      Object.values(LIVESTOCK_DEFS).forEach(def=>{
        const c = counts[def.id];
        if(c>0){
          const feed = def.feedCost * c;
          if(state.gold >= feed){
            state.gold -= feed;
            log(`${def.emoji} ${def.name} ${c}ë§ˆë¦¬ì—ê²Œ ì‚¬ë£Œë¥¼ ì£¼ì—ˆìŠµë‹ˆë‹¤. (-${feed}G)`);
          } else {
            log(`${def.emoji} ${def.name}ì—ê²Œ ì¤„ ì‚¬ë£Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ì˜¤ëŠ˜ì€ êµ¶ê²¼ìŠµë‹ˆë‹¤...`);
          }
        }
      });
    }

    function generateDailyQuestOffers(){
      state.questOffers = [];
      for(let i=0;i<3;i++){
        const cropId = randomChoice(Object.keys(crops));
        const crop = crops[cropId];
        const target = 2 + Math.floor(Math.random()*4);
        const reward = target * (crop.sellPrice + 10);
        const res = randomChoice(state.residents);
        state.questOffers.push({
          cropId,
          target,
          reward,
          clientResidentId: res.id,
          accepted:false
        });
      }
      log("ì˜¤ëŠ˜ì˜ ë§ˆì„ ì‹ ê·œ ì˜ë¢° 3ê±´ì´ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function generateVillageEvent(){
      const r = Math.random();
      if(r < 0.4){
        const gain = 100 + Math.floor(Math.random()*151);
        state.gold += gain;
        state.villageEvent = {
          title:"ë– ëŒì´ ìƒì¸ì˜ ë°©ë¬¸",
          text:`ë– ëŒì´ ìƒì¸ì´ ë‚¨ê¸´ ë¬¼ê±´ì„ ë˜íŒ”ì•„ ${gain}Gë¥¼ ë²Œì—ˆìŠµë‹ˆë‹¤.`
        };
        log(`ë§ˆì„ ì´ë²¤íŠ¸: ë– ëŒì´ ìƒì¸ì˜ ë°©ë¬¸ (+${gain}G)`);
      } else if(r < 0.7){
        const amount = Math.min(state.gold, 80 + Math.floor(Math.random()*121));
        state.gold -= amount;
        state.villageEvent = {
          title:"ë§ˆì„ ê³µë™ ê¸°ê¸ˆ ëª¨ê¸ˆì¼",
          text:`ë§ˆì„ ìš°ë¬¼ê³¼ ê¸¸ ë³´ìˆ˜ë¥¼ ìœ„í•´ ${amount}Gë¥¼ ê¸°ë¶€í–ˆìŠµë‹ˆë‹¤.`
        };
        log(`ë§ˆì„ ì´ë²¤íŠ¸: ê³µë™ ê¸°ê¸ˆ ëª¨ê¸ˆì¼ (-${amount}G)`);
      } else if(r < 0.85){
        state.maxEnergy += 10;
        state.energy = state.maxEnergy;
        state.villageEvent = {
          title:"ì‘ì€ ì¶•ì œ",
          text:"ë§ˆì„ì—ì„œ ì—´ë¦° ì‘ì€ ì¶•ì œì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤. ê¸°ë¶„ì´ ì¢‹ì•„ì ¸ ë‚´ì¼ ë” ì˜¤ë˜ ì¼í•  ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤. (ìµœëŒ€ ì—ë„ˆì§€ +10)"
        };
        log("ë§ˆì„ ì´ë²¤íŠ¸: ì‘ì€ ì¶•ì œ (ìµœëŒ€ ì—ë„ˆì§€ +10)");
      } else {
        const item = randomChoice(Object.values(ITEM_DEFS));
        state.items[item.id] = (state.items[item.id]||0) + 1;
        state.villageEvent = {
          title:"ì£¼ë¯¼ì˜ ì„ ë¬¼",
          text:`ê³ ë§ˆì›€ì„ ì „í•˜ê³  ì‹¶ì—ˆë˜ ì£¼ë¯¼ì´ ${item.name}ì„(ë¥¼) ì„ ë¬¼í–ˆìŠµë‹ˆë‹¤. (ì•„ì´í…œ +1)`
        };
        log(`ë§ˆì„ ì´ë²¤íŠ¸: ${item.name} ì„ ë¬¼ì„ ë°›ì•˜ìŠµë‹ˆë‹¤.`);
      }
    }

    function spouseHelpDaily(){
      if(!state.marriedResidentId) return;
      const sp = state.residents.find(r=>r.id===state.marriedResidentId);
      if(!sp) return;
      let affected = 0;
      const seasonId = getSeasonId();
      const inSeasonCrops = Object.values(crops).filter(c=>c.seasons.includes(seasonId));
      state.tiles.forEach(t=>{
        if(t.locked) return;
        if(Math.random() < 0.3){
          if(t.type==="tilled" && !t.cropId && inSeasonCrops.length>0){
            const crop = randomChoice(inSeasonCrops);
            t.type = "crop";
            t.cropId = crop.id;
            t.stage = 1;
            t.wateredToday = false;
            t.quality = 1.0;
            affected++;
          } else if(t.type==="crop" && t.cropId && !t.wateredToday){
            t.wateredToday = true;
            affected++;
          }
        }
      });
      if(affected>0){
        log(`ğŸ’ ${sp.name}ì´(ê°€) ìƒˆë²½ì— ë†ì¥ì„ ë„ì™€ ${affected}ì¹¸ì˜ ì‘ì—…ì„ ëŒ€ì‹ í•´ ì£¼ì—ˆìŠµë‹ˆë‹¤.`);
      }
    }

    function nextDay(){
      if(state.gameCompleted){
        log("ì´ë¯¸ ëª¨ë“  ë¹šì„ ê°šì•˜ìŠµë‹ˆë‹¤. ì—”ë”© ì´í›„ì—ëŠ” ììœ ë¡­ê²Œ ë‘˜ëŸ¬ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        return;
      }
      state.day++;
      state.seasonDay++;
      let seasonChanged = false;
      if(state.seasonDay > DAYS_PER_SEASON){
        state.seasonDay = 1;
        state.seasonIndex = (state.seasonIndex+1) % seasonIds.length;
        seasonChanged = true;
        log(`=== ìƒˆë¡œìš´ ê³„ì ˆ, ${seasonNames[getSeasonId()]}ì´(ê°€) ì°¾ì•„ì™”ìŠµë‹ˆë‹¤! ===`);
        initCropList();
      }

      state.maxEnergy = calcMaxEnergy();
      state.energy = state.maxEnergy;

      const currentSeason = getSeasonId();

      if(seasonChanged){
        let degraded = 0;
        state.tiles.forEach(t=>{
          if(t.locked) return;
          if(t.type==="crop" && t.cropId){
            const crop = crops[t.cropId];
            if(t.stage >= crop.growStages && !crop.seasons.includes(currentSeason)){
              t.quality = 0.5;
              degraded++;
            }
          }
        });
        if(degraded>0){
          log(`ê³„ì ˆì´ ë°”ë€Œë©° ${degraded}ì¹¸ì˜ ì‘ë¬¼ì´ ì œì² ì„ ë†“ì³ í•˜ê¸‰í’ˆì´ ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
      }

      // ì‘ë¬¼ ì„±ì¥
      state.tiles.forEach(t=>{
        if(t.locked) { t.wateredToday=false; return; }
        if(t.type==="crop" && t.cropId){
          const crop = crops[t.cropId];
          if(t.wateredToday && t.stage < crop.growStages){
            let growChance = 1.0;
            if(!crop.seasons.includes(currentSeason)) growChance = 0.5;
            if(Math.random()<growChance) t.stage++;
          }
          t.wateredToday = false;
        } else {
          t.wateredToday = false;
        }
      });

      state.weatherId = pickRandomWeather();
      const w = getWeatherDef();
      log(`=== ${seasonNames[currentSeason]} ${state.seasonDay}ì¼ì°¨, ë‚ ì”¨: ${w.icon} ${w.name} ===`);
      log(w.desc);

      if(state.weatherId==="rain"){
        state.tiles.forEach(t=>{
          if(t.locked) return;
          if(t.type==="crop" && t.cropId) t.wateredToday=true;
        });
        log("ë¹„ê°€ ë‚´ë ¤ ì˜¤ëŠ˜ì€ ëª¨ë“  ì‘ë¬¼ì´ ìë™ìœ¼ë¡œ ë¬¼ì„ ë°›ì•˜ìŠµë‹ˆë‹¤.");
      }

      handleLivestockDaily();
      generateDailyQuestOffers();
      generateVillageEvent();
      spouseHelpDaily();

      updateUI();
    }

    // ===== ì•„ì´í…œ ì‚¬ìš© & íŒë§¤ =====
    function useItem(id, amount, silent){
      amount = Math.max(1, amount);
      let available = state.items[id] || 0;
      if(available <= 0){
        alert("ì‚¬ìš©í•  ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      const useCount = Math.min(available, amount);
      const def = ITEM_DEFS[id];
      for(let i=0;i<useCount;i++){
        switch(id){
          case "coffee":
            state.energy = Math.min(state.maxEnergy, state.energy+25);
            break;
          case "bread":
            state.energy = Math.min(state.maxEnergy, state.energy+35);
            break;
          case "lunchbox":
            state.energy = Math.min(state.maxEnergy, state.energy+60);
            break;
          case "energyDrink":
            state.energy = state.maxEnergy;
            break;
          case "fertilizer":
            applyFertilizer();
            break;
          case "contractor":
            applyContractor();
            break;
          case "luckyCoin":
            state.gold += 200;
            break;
          case "oreBox":
            state.warehouse.ores.stone += 5 + Math.floor(Math.random()*6);
            state.warehouse.ores.copper += 2 + Math.floor(Math.random()*3);
            if(Math.random()<0.5) state.warehouse.ores.iron += 1 + Math.floor(Math.random()*2);
            break;
          case "fishBox":
            Object.values(FISH).forEach(f=>{
              if(Math.random()<0.5){
                state.warehouse.fish[f.id] += 1 + Math.floor(Math.random()*2);
              }
            });
            break;
          case "animalSnack":
            const cowCount = state.ranchStalls.filter(s=>s.animalId==="cow").length;
            const sheepCount = state.ranchStalls.filter(s=>s.animalId==="sheep").length;
            state.warehouse.animal.milk += cowCount;
            state.warehouse.animal.wool += sheepCount;
            break;
        }
      }
      state.items[id] = available - useCount;
      if(!silent){
        log(`${def.name}ì„(ë¥¼) ${useCount}ê°œ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`);
      }
      updateStatsUI();
      updateWarehouseUI();
      updateItemsUI();
    }

    function applyFertilizer(){
      const indices = [];
      state.tiles.forEach((t,idx)=>{
        if(t.locked) return;
        if(t.type==="crop" && t.cropId){
          const crop = crops[t.cropId];
          if(t.stage < crop.growStages) indices.push(idx);
        }
      });
      if(indices.length===0){
        log("ë¹„ë£Œë¥¼ ë¿Œë¦´ë§Œí•œ ì‘ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      for(let i=indices.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [indices[i],indices[j]] = [indices[j],indices[i]];
      }
      const maxTargets = 12;
      let affected = 0;
      indices.slice(0,maxTargets).forEach(idx=>{
        const t = state.tiles[idx];
        const crop = crops[t.cropId];
        if(t.stage < crop.growStages){
          t.stage++;
          affected++;
        }
      });
      log(`ğŸ§ª ë¹„ë£Œë¥¼ ì‚¬ìš©í•´ ${affected}ì¹¸ì˜ ì‘ë¬¼ì´ í•œ ë‹¨ê³„ ì„±ì¥í–ˆìŠµë‹ˆë‹¤.`);
    }

    function applyContractor(){
      let watered = 0, harvested = 0;
      state.tiles.forEach(t=>{
        if(t.locked) return;
        if(t.type==="crop" && t.cropId){
          const crop = crops[t.cropId];
          if(t.stage >= crop.growStages){
            const isLow = t.quality && t.quality<1;
            const entry = state.warehouse.crops[crop.id];
            if(isLow) entry.low++;
            else entry.normal++;
            t.type="tilled";
            t.stage=0;
            t.cropId=null;
            t.wateredToday=false;
            t.quality=1.0;
            harvested++;
          } else {
            if(!t.wateredToday){
              t.wateredToday=true;
              watered++;
            }
          }
        }
      });
      log(`ğŸ“¦ ìš©ì—­ì—…ì²´ê°€ ëŒ€ì‹  ë°­ì„ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤. ë¬¼ì£¼ê¸° ${watered}ì¹¸, ìˆ˜í™• ${harvested}ì¹¸ ì²˜ë¦¬.`);
    }

    function sellItem(id, amount){
      if(amount<=0) return;
      const available = state.items[id] || 0;
      if(available<=0){
        alert("íŒë§¤í•  ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      const def = ITEM_DEFS[id];
      const qty = Math.min(available, amount);
      const gain = qty * def.sellPrice;
      state.items[id] -= qty;
      state.gold += gain;
      log(`${def.name} ${qty}ê°œë¥¼ íŒë§¤í–ˆìŠµë‹ˆë‹¤. (+${gain}G)`);
      updateStatsUI();
      updateWarehouseUI();
      updateItemsUI();
    }

    // ===== ì§‘ & ë„êµ¬ ì—…ê·¸ë ˆì´ë“œ =====
    function upgradeHouse(){
      const current = state.houseLevel;
      const levelCfg = HOUSE_LEVELS.find(h=>h.level===current);
      const nextCfg = HOUSE_LEVELS.find(h=>h.level===current+1);
      if(!nextCfg){
        log("ì§‘ì€ ì´ë¯¸ ìµœëŒ€ ë ˆë²¨ì…ë‹ˆë‹¤.");
        return;
      }
      if(state.gold < nextCfg.upgradeCost){
        alert(`ì§‘ì„ ì—…ê·¸ë ˆì´ë“œí•  ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${nextCfg.upgradeCost}G)`);
        return;
      }
      state.gold -= nextCfg.upgradeCost;
      state.houseLevel = nextCfg.level;
      state.maxEnergy = calcMaxEnergy();
      state.energy = state.maxEnergy;
      log(`ì§‘ì´ "${nextCfg.name}"(ìœ¼)ë¡œ ì—…ê·¸ë ˆì´ë“œë˜ì—ˆìŠµë‹ˆë‹¤! ìµœëŒ€ ì—ë„ˆì§€ê°€ ${state.maxEnergy}ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      updateUI();
    }

    function upgradeTool(id){
      const level = state.toolLevels[id] || 1;
      if(level >= MAX_TOOL_LEVEL){
        log(`${getToolName(id)}ëŠ” ì´ë¯¸ ìµœëŒ€ ë ˆë²¨ì…ë‹ˆë‹¤.`);
        return;
      }
      const cost = 1000 * level;
      if(state.gold < cost){
        alert(`${getToolName(id)}ë¥¼ ì—…ê·¸ë ˆì´ë“œí•  ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${cost}G)`);
        return;
      }
      state.gold -= cost;
      state.toolLevels[id] = level+1;
      log(`${getToolName(id)}ê°€ Lv.${level+1}(ìœ¼)ë¡œ ì—…ê·¸ë ˆì´ë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
      updateUI();
    }

    // ===== ê²°í˜¼ =====
    function marryResident(resId){
      if(state.marriedResidentId){
        log("ì´ë¯¸ ê²°í˜¼í•œ ìƒíƒœì…ë‹ˆë‹¤.");
        return;
      }
      const res = state.residents.find(r=>r.id===resId);
      if(!res || res.affinity<100){
        log("ì•„ì§ í˜¸ê°ë„ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }
      res.married = true;
      state.marriedResidentId = res.id;
      log(`${res.name}ê³¼(ì™€) ê²°í˜¼í–ˆìŠµë‹ˆë‹¤! ì´ì œ ìƒˆë²½ë§ˆë‹¤ ë†ì¥ì„ ì¡°ê¸ˆ ë„ì™€ì¤ë‹ˆë‹¤.`);
      updateUI();
    }

    // ===== ì°½ê³  íŒë§¤ & í€˜ìŠ¤íŠ¸ ì—°ë™ =====
    function sellCrop(cropId, quality, amount){
      if(amount<=0) return;
      const entry = state.warehouse.crops[cropId];
      const available = (quality==="low" ? entry.low : entry.normal);
      if(available<=0){
        alert("íŒë§¤í•  ì‘ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      const qty = Math.min(available, amount);
      const crop = crops[cropId];
      const price = (quality==="low" ? Math.floor(crop.sellPrice*0.5) : crop.sellPrice);
      const gain = qty * price;
      if(quality==="low") entry.low -= qty;
      else entry.normal -= qty;
      state.gold += gain;
      log(`${crop.name} ${quality==="low"?"(í•˜ê¸‰í’ˆ)":""} ${qty}ê°œë¥¼ íŒë§¤í–ˆìŠµë‹ˆë‹¤. (+${gain}G)`);
      applyQuestProgressFromSale(cropId, qty);
      updateStatsUI();
      updateWarehouseUI();
      updateResidentsUI();
      updateQuestUI();
    }

    function applyQuestProgressFromSale(cropId, qtySold){
      let remaining = qtySold;
      state.activeQuests.forEach(q=>{
        if(q.completed || q.cropId!==cropId) return;
        if(remaining<=0) return;
        const need = q.target - q.progress;
        const use = Math.min(need, remaining);
        if(use<=0) return;
        q.progress += use;
        remaining -= use;
        const crop = crops[cropId];
        const res = state.residents.find(r=>r.id===q.clientResidentId);
        log(`ì˜ë¢° ì§„í–‰: ${res ? res.name : "???"}ì˜ ${crop.name} ë‚©í’ˆ ${q.progress}/${q.target}`);
        if(q.progress >= q.target){
          q.completed = true;
          state.gold += q.reward;
          if(res){
            res.affinity = Math.min(100, res.affinity + 15);
          }
          log(`í€˜ìŠ¤íŠ¸ ì™„ë£Œ! ë³´ìƒìœ¼ë¡œ ${q.reward}Gë¥¼ ë°›ì•˜ê³ , ${res ? res.name : "???"}ì˜ í˜¸ê°ë„ê°€ ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤.`);
        }
      });
      updateStatsUI();
    }

    function sellAnimalProduct(id, amount){
      if(amount<=0) return;
      const available = state.warehouse.animal[id] || 0;
      if(available<=0){
        alert("íŒë§¤í•  ê°€ì¶• ë¶€ì‚°ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      const def = ANIMAL_PRODUCTS[id];
      const qty = Math.min(available, amount);
      const gain = qty * def.sellPrice;
      state.warehouse.animal[id] -= qty;
      state.gold += gain;
      log(`${def.name} ${qty}ê°œë¥¼ íŒë§¤í–ˆìŠµë‹ˆë‹¤. (+${gain}G)`);
      updateStatsUI();
      updateWarehouseUI();
    }

    function sellOre(id, amount){
      if(amount<=0) return;
      const available = state.warehouse.ores[id] || 0;
      if(available<=0){
        alert("íŒë§¤í•  ê´‘ì„ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      const def = ORES[id];
      const qty = Math.min(available, amount);
      const gain = qty * def.sellPrice;
      state.warehouse.ores[id] -= qty;
      state.gold += gain;
      log(`${def.name} ${qty}ê°œë¥¼ íŒë§¤í–ˆìŠµë‹ˆë‹¤. (+${gain}G)`);
      updateStatsUI();
      updateWarehouseUI();
    }

    function sellFish(id, amount){
      if(amount<=0) return;
      const available = state.warehouse.fish[id] || 0;
      if(available<=0){
        alert("íŒë§¤í•  ìƒì„ ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      const def = FISH[id];
      const qty = Math.min(available, amount);
      const gain = qty * def.sellPrice;
      state.warehouse.fish[id] -= qty;
      state.gold += gain;
      log(`${def.name} ${qty}ë§ˆë¦¬ë¥¼ íŒë§¤í–ˆìŠµë‹ˆë‹¤. (+${gain}G)`);
      updateStatsUI();
      updateWarehouseUI();
    }

    // ===== ê´‘ì‚° & ë‚šì‹œ =====
    function mineExplore(){
      if(!spendEnergy(MINE_ENERGY_COST)) return;
      const r = Math.random();
      if(r < 0.25){
        state.warehouse.ores.stone += 5 + Math.floor(Math.random()*6);
        log("â› ëŒì„ ì”ëœ© ìºëƒˆìŠµë‹ˆë‹¤.");
      } else if(r < 0.55){
        state.warehouse.ores.copper += 2 + Math.floor(Math.random()*3);
        log("â› êµ¬ë¦¬ ê´‘ì„ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.");
      } else if(r < 0.8){
        state.warehouse.ores.iron += 1 + Math.floor(Math.random()*3);
        log("â› ì²  ê´‘ì„ì„ ì±„êµ´í–ˆìŠµë‹ˆë‹¤.");
      } else {
        state.warehouse.ores.goldOre += 1;
        log("ğŸ’° ë°˜ì§ì´ëŠ” ê¸ˆ ê´‘ì„ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!");
      }
      updateStatsUI();
      updateWarehouseUI();
    }

    function goFishing(){
      if(!spendEnergy(FISH_ENERGY_COST)) return;
      const r = Math.random();
      let id, qty;
      if(r < 0.35){
        id = "pirami"; qty = 1 + Math.floor(Math.random()*3);
      } else if(r < 0.7){
        id = "songsari"; qty = 1 + Math.floor(Math.random()*2);
      } else if(r < 0.9){
        id = "bungeo"; qty = 1 + Math.floor(Math.random()*2);
      } else {
        id = "inge"; qty = 1;
      }
      state.warehouse.fish[id] += qty;
      log(`ğŸ£ ${FISH[id].name} ${qty}ë§ˆë¦¬ë¥¼ ë‚šì•˜ìŠµë‹ˆë‹¤.`);
      updateStatsUI();
      updateWarehouseUI();
    }

    // ===== ìœ ì¶•ê¸° & ì–‘í„¸ê°€ìœ„ =====
    function milkCows(){
      const cowCount = state.ranchStalls.filter(s=>s.animalId==="cow").length;
      if(cowCount===0){
        log("ìš°ìœ ë¥¼ ì§¤ ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      const energyCost = calcAnimalToolEnergy("milker", cowCount);
      if(!spendEnergy(energyCost)) return;
      const level = state.toolLevels.milker || 1;
      const milkPerCow = level;
      const totalMilk = cowCount * milkPerCow;
      state.warehouse.animal.milk += totalMilk;
      log(`ğŸ¥› ìœ ì¶•ê¸°ë¥¼ ì‚¬ìš©í•´ ì†Œ ${cowCount}ë§ˆë¦¬ì—ì„œ ìš°ìœ  ${totalMilk}ê°œë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤. (-${energyCost} ì—ë„ˆì§€)`);
      updateStatsUI();
      updateWarehouseUI();
    }

    function shearSheep(){
      const sheepCount = state.ranchStalls.filter(s=>s.animalId==="sheep").length;
      if(sheepCount===0){
        log("ì–‘í„¸ì„ ê¹ì„ ì–‘ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      const energyCost = calcAnimalToolEnergy("shears", sheepCount);
      if(!spendEnergy(energyCost)) return;
      const level = state.toolLevels.shears || 1;
      const woolPerSheep = level;
      const totalWool = sheepCount * woolPerSheep;
      state.warehouse.animal.wool += totalWool;
      log(`âœ‚ï¸ ì–‘í„¸ê°€ìœ„ë¥¼ ì‚¬ìš©í•´ ì–‘ ${sheepCount}ë§ˆë¦¬ì—ì„œ ì–‘í„¸ ${totalWool}ê°œë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤. (-${energyCost} ì—ë„ˆì§€)`);
      updateStatsUI();
      updateWarehouseUI();
    }

    // ===== ë¹š ë³€ì œ =====
    function payDebt(){
      const val = parseInt(debtPayInput.value,10);
      if(!val || val<=0){
        alert("ë¹› ë³€ì œ ê¸ˆì•¡ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      if(state.debt<=0){
        log("ì´ë¯¸ ëª¨ë“  ë¹šì„ ê°šì•˜ìŠµë‹ˆë‹¤.");
        return;
      }
      if(val > state.gold){
        alert("ë³´ìœ  ê³¨ë“œë³´ë‹¤ ë§ì€ ê¸ˆì•¡ì€ ë³€ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      const pay = Math.min(val, state.debt);
      state.gold -= pay;
      state.debt -= pay;
      log(`ğŸ’¸ ë¹š ${pay}Gë¥¼ ë³€ì œí–ˆìŠµë‹ˆë‹¤. (ë‚¨ì€ ë¹š: ${state.debt}G)`);
      if(state.debt<=0){
        state.debt = 0;
        state.gameCompleted = true;
        log("ğŸ‰ ëª¨ë“  ë¹šì„ ê°šì•˜ìŠµë‹ˆë‹¤! ë†ì¥ ì¸ìƒì˜ ìƒˆë¡œìš´ ì‹œì‘ì…ë‹ˆë‹¤. (ì—”ë”©)");
      }
      updateStatsUI();
    }

    // ===== ì˜ë¢° ìˆ˜ë½/ì·¨ì†Œ =====
    function acceptQuest(offerIndex){
      const offer = state.questOffers[offerIndex];
      if(!offer || offer.accepted) return;
      offer.accepted = true;
      state.activeQuests.push({
        cropId: offer.cropId,
        target: offer.target,
        progress:0,
        reward: offer.reward,
        clientResidentId: offer.clientResidentId,
        completed:false
      });
      const res = state.residents.find(r=>r.id===offer.clientResidentId);
      const crop = crops[offer.cropId];
      log(`"${res ? res.name : "???"}"ì˜ ${crop.name} ì˜ë¢°ë¥¼ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤. (ì´ ì˜ë¢°ëŠ” ì™„ë£Œí•˜ê±°ë‚˜ ì·¨ì†Œí•  ë•Œê¹Œì§€ ìœ ì§€ë©ë‹ˆë‹¤.)`);
      updateQuestUI();
    }

    function cancelActiveQuest(index){
      const q = state.activeQuests[index];
      if(!q) return;
      const crop = crops[q.cropId];
      const res = state.residents.find(r=>r.id===q.clientResidentId);
      log(`"${res ? res.name : "???"}"ì˜ ${crop.name} ì˜ë¢°ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.`);
      state.activeQuests.splice(index,1);
      updateQuestUI();
    }

    // ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© =====
    toolButtons.forEach(btn=>{
      btn.addEventListener("click",()=>{
        const tool = btn.getAttribute("data-tool");
        if(!tool) return;
        toolButtons.forEach(b=>b.classList.remove("selected"));
        btn.classList.add("selected");
        state.activeTool = tool;
        updateToolHint();
      });
    });

    ranchAnimalButtons.forEach(btn=>{
      btn.addEventListener("click",()=>{
        const a = btn.getAttribute("data-animal");
        if(!a) return;
        state.ranchSelectedAnimal = a;
        updateRanchUI();
      });
    });

    nextDayBtn.addEventListener("click", nextDay);
    mineExploreBtn.addEventListener("click", mineExplore);
    fishBtn.addEventListener("click", goFishing);
    milkBtn.addEventListener("click", milkCows);
    shearBtn.addEventListener("click", shearSheep);
    debtPayBtn.addEventListener("click", payDebt);

    const bgmToggleBtnEl = bgmToggleBtn;
    bgmToggleBtnEl.addEventListener("click",()=>{
      if(bgmAudio.paused){
        bgmAudio.play().then(()=>{
          bgmToggleBtnEl.textContent = "ğŸ”Š BGM ë„ê¸°";
        }).catch(()=>{
          log("ë¸Œë¼ìš°ì € ìë™ ì¬ìƒ ì œí•œìœ¼ë¡œ ì¸í•´, ë‹¤ì‹œ í•œ ë²ˆ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
        });
      } else {
        bgmAudio.pause();
        bgmToggleBtnEl.textContent = "ğŸ”ˆ BGM ì¼œê¸°";
      }
    });

    let explainOpen = false;
    explainToggleBtn.addEventListener("click",()=>{
      explainOpen = !explainOpen;
      explainBody.classList.toggle("collapsed", !explainOpen);
      explainToggleBtn.textContent = explainOpen ? "ë‹«ê¸°" : "ë”ë³´ê¸°";
    });

    // ===== ì‹œì‘ =====
    initFarm();
    initRanch();
    initCropList();
    generateDailyQuestOffers();
    generateVillageEvent();
    updateUI();
  </script>
</body>
</html>

